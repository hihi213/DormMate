# docker-compose.yml - 기본/공통 설정
# 모든 환경(개발/운영)에서 공통으로 사용되는 서비스(컨테이너)들을 정의하는 파일입니다.
# 'docker-compose up' 명령어로 이 파일에 정의된 모든 서비스를 한 번에 실행, 관리할 수 있습니다.

services: # 이 파일로 관리할 컨테이너(서비스)들의 목록을 정의하는 최상위 키입니다.
  # PostgreSQL Database
  # 우리 애플리케이션의 핵심 데이터를 저장할 PostgreSQL 데이터베이스 서비스입니다.
  db:
    image: postgres:16.4-alpine # 사용할 도커 이미지입니다. 'postgres'의 16 버전을 사용하며, 'alpine'은 경량화된 리눅스 배포판으로 이미지 크기를 줄여줍니다.
    container_name: dorm_postgres # 컨테이너에 고정된 이름을 부여하여 다른 서비스에서 쉽게 참조하고 관리할 수 있게 합니다.
    environment: # 컨테이너 내부에 환경 변수를 설정합니다. 주로 설정이나 비밀번호 등에 사용됩니다.
      # .env 파일이나 셸 환경변수가 없으면 ':-' 뒤의 기본값을 사용합니다.
      POSTGRES_DB: ${POSTGRES_DB:-dormitory_db} # 생성할 데이터베이스의 이름을 지정합니다.
      POSTGRES_USER: ${POSTGRES_USER:-dorm_user} # 데이터베이스에 접근할 사용자 이름을 지정합니다.
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dorm_password} # 해당 사용자의 비밀번호를 지정합니다.
    volumes:
      # 컨테이너의 데이터를 호스트 머신에 영속적으로 저장하기 위한 설정입니다.
      # 컨테이너가 삭제되어도 데이터는 호스트의 './db_data' 디렉토리에 남아있게 됩니다.
      - ./db_data:/var/lib/postgresql/data # [호스트 경로]:[컨테이너 경로] 형식입니다.
    healthcheck:
      # 컨테이너가 정상적으로 동작하는지 확인하는 방법과 주기를 정의합니다.
      # 이 상태는 다른 서비스가 이 서비스에 의존할 때 시작 순서를 제어하는 데 사용됩니다.
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-dorm_user} -d ${POSTGRES_DB:-dormitory_db} || exit 1"] # pg_isready 명령어로 DB 연결 가능 여부를 확인합니다. 실패 시 종료 코드 1을 반환합니다.
      interval: 5s # 5초마다 healthcheck를 실행합니다.
      timeout: 3s # healthcheck 실행 후 3초 이내에 응답이 없으면 실패로 간주합니다.
      retries: 15 # 실패 시 15번 재시도합니다. 이 횟수를 넘으면 최종적으로 'unhealthy' 상태가 됩니다.

  # Redis Cache
  # 인메모리 데이터 저장소로, 캐싱, 세션 관리 등 빠른 데이터 조회가 필요할 때 사용됩니다.
  redis:
    image: redis:7.2-alpine # Redis 7.2 버전 이미지를 사용합니다. (alpine 기반으로 경량화)
    container_name: dorm_redis # 컨테이너에 고정 이름을 부여합니다.

  # pgAdmin Database Management
  # PostgreSQL 데이터베이스를 웹 UI를 통해 쉽게 관리하고 쿼리할 수 있는 도구입니다.
  pgadmin:
    image: dpage/pgadmin4:8.6 # pgAdmin4의 8.6 버전 이미지를 사용합니다.
    container_name: dorm_pgadmin # 컨테이너에 고정 이름을 부여합니다.
    depends_on:
      # 서비스 시작 순서를 제어합니다. pgadmin은 db 서비스가 'healthy' 상태가 된 후에 시작됩니다.
      # 이를 통해 DB가 준비되지 않은 상태에서 pgadmin이 실행되어 연결 오류가 발생하는 것을 방지합니다.
      db:
        condition: service_healthy
    environment:
      # pgAdmin 웹 UI에 처음 로그인할 때 사용할 이메일과 비밀번호를 설정합니다.
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
    volumes:
      # pgadmin에서 생성한 서버 연결 정보, 쿼리 히스토리 등을 영속적으로 저장하기 위한 볼륨입니다.
      - pgadmin-data:/var/lib/pgadmin

  # Flyway Database Migration
  # 데이터베이스 스키마 변경(마이그레이션)을 버전 관리하고 자동으로 적용해주는 도구입니다.
  migrate:
    image: flyway/flyway:10.17.0 # Flyway 10.17 버전 이미지를 사용합니다.
    container_name: dorm_flyway # 컨테이너에 고정 이름을 부여합니다.
    depends_on:
      # Flyway 역시 DB가 완전히 준비된 상태에서 실행되어야 하므로, db 서비스의 'healthy' 상태를 기다립니다.
      db:
        condition: service_healthy
    command:
      # 이 컨테이너가 실행될 때 수행할 명령어입니다. Flyway CLI의 인자들을 전달합니다.
      - "-url=jdbc:postgresql://db:5432/${POSTGRES_DB:-dormitory_db}" # 접속할 DB의 URL. 'db'는 위에서 정의한 PostgreSQL 서비스의 이름입니다. Docker Compose의 내부 DNS가 서비스 이름을 호스트 이름으로 해석해줍니다.
      - "-user=${POSTGRES_USER:-dorm_user}" # DB 접속 유저
      - "-password=${POSTGRES_PASSWORD:-dorm_password}" # DB 접속 비밀번호
      - "-baselineOnMigrate=true" # DB에 flyway 히스토리 테이블이 없을 경우, 현재 상태를 기준으로 베이스라인(V1)을 생성하고 마이그레이션을 시작합니다. 기존에 데이터가 있는 DB에 Flyway를 처음 도입할 때 유용합니다.
      - "migrate" # 실제 마이그레이션을 수행하라는 명령어입니다.
    volumes:
      # 호스트 머신의 SQL 마이그레이션 파일들을 컨테이너의 Flyway가 인식하는 경로로 마운트합니다.
      # ':ro'는 read-only(읽기 전용)를 의미하며, 컨테이너가 실수로 마이그레이션 파일을 수정하는 것을 방지하는 좋은 습관입니다.
      - ./backend/src/main/resources/db/migration:/flyway/sql:ro
    restart: "unless-stopped" # 컨테이너가 비정상 종료되었을 때, 사용자가 명시적으로 중지하지 않는 한 자동으로 재시작합니다. 마이그레이션은 보통 한 번만 실행되지만, 이 설정은 docker-compose up 시 항상 실행을 시도하도록 보장합니다.

volumes:
  # 이 docker-compose 파일 내에서 사용할 명명된 볼륨(named volume)을 정의합니다.
  # 명명된 볼륨은 Docker가 관리하는 특정 경로에 데이터를 저장하며, 호스트 경로를 직접 지정하는 것보다 이식성이 높습니다.
  pgadmin-data:
