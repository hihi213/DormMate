name: Schema Drift (migra)

on:
  # í•„ìš”ì‹œ pull_request ì´ë²¤íŠ¸ë„ ì¼œì„œ PRë§ˆë‹¤ ê²€ì‚¬í•˜ë„ë¡ í•  ìˆ˜ ìˆìŒ
  workflow_dispatch:
  # pull_request:
  #   branches: [ main ]

permissions:
  contents: read

jobs:
  drift:
    runs-on: ubuntu-latest

    # âœ… expected(ì˜ë„ëœ ìŠ¤í‚¤ë§ˆ) ìƒì„±ì„ ìœ„í•œ Postgres ì„œë¹„ìŠ¤
    #   - ì´ ì»¨í…Œì´ë„ˆì— ë ˆí¬ì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì ìš©í•´ì„œ "ê¸°ëŒ€ ìŠ¤í‚¤ë§ˆ"ë¥¼ ë§Œë“  ë’¤
    #   - ì‹¤ì œ DB(actual)ì™€ migraë¡œ ë¹„êµí•©ë‹ˆë‹¤.
    services:
      pg:
        image: postgres:15
        env:
          POSTGRES_USER: dorm_user
          POSTGRES_PASSWORD: dorm_password
          POSTGRES_DB: dormitory_expected
        ports:
          - 5433:5432   # í˜¸ìŠ¤íŠ¸:ì»¨í…Œì´ë„ˆ â†’ localhost:5433
        # ì»¨í…Œì´ë„ˆ ì¤€ë¹„ë  ë•Œê¹Œì§€ healthcheckë¡œ ëŒ€ê¸°
        options: >-
          --health-cmd="pg_isready -U dorm_user -d dormitory_expected"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    env:
      # ğŸ”§ í•„ìš”ì‹œ ìŠ¤í‚¤ë§ˆ ë²”ìœ„ë¥¼ ì œí•œí•˜ë ¤ë©´ (ê¸°ë³¸: public)
      MIGRA_SCHEMA: "public"
      # ê¶Œí•œ/GRANTê¹Œì§€ ë¹„êµí•˜ê³  ì‹¶ìœ¼ë©´ trueë¡œ (ê¸°ë³¸: false)
      MIGRA_WITH_PRIVILEGES: "false"
      # DROP ë“± íŒŒê´´ì  ë³€ê²½ê¹Œì§€ SQLì— í¬í•¨í•˜ë ¤ë©´ trueë¡œ (CI íŒì •ì—ëŠ” ë³´í†µ ë¶ˆí•„ìš”)
      MIGRA_UNSAFE: "false"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # âœ… Flyway CLI ì„¤ì¹˜ (ë°”ì´ë„ˆë¦¬ ì‚¬ìš© â†’ ë„¤íŠ¸ì›Œí‚¹ ê°„ë‹¨)
      - name: Install Flyway CLI
        run: |
          curl -L https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/10.17.0/flyway-commandline-10.17.0-linux-x64.tar.gz -o /tmp/flyway.tar.gz
          tar -xzf /tmp/flyway.tar.gz -C /tmp
          sudo mv /tmp/flyway-10.17.0/flyway /usr/local/bin/flyway
          flyway -v

      # âœ… ë ˆí¬ì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ â†’ expected DBì— ì ìš© (ê¸°ëŒ€ ìŠ¤í‚¤ë§ˆ ìƒì„±)
      #    - í™•ì¥(citext, btree_gist ë“±)ì€ ë§ˆì´ê·¸ íŒŒì¼ì— í¬í•¨ë˜ì–´ ìˆì–´ì•¼ í•¨
      - name: Migrate expected schema (repo â†’ expected DB)
        env:
          FLYWAY_URL: jdbc:postgresql://localhost:5433/dormitory_expected
          FLYWAY_USER: dorm_user
          FLYWAY_PASSWORD: dorm_password
        run: |
          flyway \
            -url="${FLYWAY_URL}" \
            -user="${FLYWAY_USER}" \
            -password="${FLYWAY_PASSWORD}" \
            -locations=filesystem:backend/src/main/resources/db/migration \
            migrate

      # âœ… ì‹¤ì œ DBì˜ ë§ˆì´ê·¸ ìƒíƒœ ê²€ì¦ (ì²´í¬ì„¬/ë²„ì „ ì¼ì¹˜ ì—¬ë¶€)
      #    - ë ˆí¬ ë§ˆì´ê·¸ íŒŒì¼ê³¼ ì‹¤ì œ DBê°€ "Flyway ê´€ì "ì—ì„œ ì •í•©í•œì§€ í™•ì¸
      - name: Flyway validate on ACTUAL DB
        env:
          FLYWAY_URL: jdbc:postgresql://${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}/${{ secrets.DB_NAME }}
          FLYWAY_USER: ${{ secrets.DB_USER }}
          FLYWAY_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          flyway -url="$FLYWAY_URL" -user="$FLYWAY_USER" -password="$FLYWAY_PASSWORD" \
                 -locations=filesystem:backend/src/main/resources/db/migration \
                 validate

      # âœ… Python + migra ì„¤ì¹˜
      - name: Setup Python & install migra
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install migra
        run: |
          pip install --upgrade pip
          pip install migra psycopg2-binary

      # âœ… migra ì‹¤í–‰ (actual â†’ expected)
      #    - FROM=actual(ì‹¤ì œ DB), TO=expected(ì˜ë„ëœ ìŠ¤í‚¤ë§ˆ)
      #    - ê²°ê³¼ SQLì´ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ "ìŠ¤í‚¤ë§ˆ ë“œë¦¬í”„íŠ¸"ë¡œ íŒë‹¨ â†’ ì‹¤íŒ¨ ì²˜ë¦¬
      - name: Run migra (actual â†’ expected)
        env:
          ACT_URL: postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}/${{ secrets.DB_NAME }}
          EXP_URL: postgresql://dorm_user:dorm_password@localhost:5433/dormitory_expected
        run: |
          mkdir -p artifacts

          MIGRA_FLAGS=""
          # ìŠ¤í‚¤ë§ˆ ë²”ìœ„ ì œí•œ
          if [ -n "${MIGRA_SCHEMA}" ]; then
            MIGRA_FLAGS="$MIGRA_FLAGS --schema=${MIGRA_SCHEMA}"
          fi
          # ê¶Œí•œ ë¹„êµ í¬í•¨
          if [ "${MIGRA_WITH_PRIVILEGES}" = "true" ]; then
            MIGRA_FLAGS="$MIGRA_FLAGS --with-privileges"
          fi
          # íŒŒê´´ì  ë³€ê²½ í¬í•¨ (DROP ë“±) - ë³´í†µ CI íŒì •ì—ëŠ” ë¶ˆí•„ìš”
          if [ "${MIGRA_UNSAFE}" = "true" ]; then
            MIGRA_FLAGS="$MIGRA_FLAGS --unsafe"
          fi

          # ì‹¤ì œ ì‹¤í–‰
          echo ">>> migra flags: ${MIGRA_FLAGS}"
          migra ${MIGRA_FLAGS} "$ACT_URL" "$EXP_URL" > artifacts/migra.sql || true

          echo "---- migra result (first 200 lines) ----"
          sed -n '1,200p' artifacts/migra.sql || true
          echo "----------------------------------------"

          if [ -s artifacts/migra.sql ]; then
            echo "âŒ Schema drift detected (see artifacts/migra.sql)"
            exit 1
          else
            echo "âœ… No drift"
          fi

      # í•­ìƒ ê²°ê³¼ë¬¼ ë³´ì¡´ (ì„±ê³µ/ì‹¤íŒ¨ ë¶ˆë¬¸)
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migra-output
          path: artifacts/*
