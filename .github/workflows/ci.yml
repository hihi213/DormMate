name: DormMate CI

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

jobs:
  checks:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: dormitory_db
          POSTGRES_USER: dorm_user
          POSTGRES_PASSWORD: dorm_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U dorm_user -d dormitory_db"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      CI: true
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DB: dormitory_db
      POSTGRES_USER: dorm_user
      POSTGRES_PASSWORD: dorm_password

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: |
            client/package-lock.json

      - name: Install backend dependencies
        run: |
          cd backend
          ./gradlew --version

      - name: Install frontend dependencies
        run: |
          cd client
          npm ci

      - name: Validate Taskmaster required_tests
        run: |
          if [ -d docs/tasks ]; then
            bash scripts/check-task-tests.sh
          else
            echo "docs/tasks 디렉터리가 없어서 체크를 건너뜁니다."
          fi

      - name: OpenAPI spectral lint
        run: make api-lint

      - name: Prism mock smoke test
        run: |
          npx @stoplight/prism mock docs/openapi/fridge-mvp.yaml --port 4010 &
          PRISM_PID=$!
          sleep 5
          curl -fsSL http://127.0.0.1:4010/api/auth/login -X POST -d '{}' -H "content-type: application/json" || true
          kill $PRISM_PID

      - name: Backend tests
        run: |
          cd backend
          ./gradlew clean test

      - name: Frontend unit tests
        run: |
          cd client
          npm test -- --watch=false

      - name: Playwright e2e tests
        run: |
          cd client
          npx playwright install --with-deps
          npx playwright test
