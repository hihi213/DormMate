#!/usr/bin/env bash
# DormMate automation wrapper: shortcut for tools/automation/cli.py
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$SCRIPT_DIR"
LOG_DIR_DEFAULT="$PROJECT_ROOT/logs"

# Prefer python3, fall back to python.
if command -v python3 >/dev/null 2>&1; then
  PYTHON_BIN=python3
elif command -v python >/dev/null 2>&1; then
  PYTHON_BIN=python
else
  echo "python3/python 실행 파일을 찾을 수 없습니다." >&2
  exit 1
fi

should_log=0
if [[ "${DM_LOG_DIR:-}" != "" ]]; then
  should_log=1
else
  case "${1:-}" in
    tests) should_log=1 ;;
    dev)
      if [[ "${2:-}" == "warmup" ]]; then
        should_log=1
      fi
      ;;
  esac
fi

if [[ "$should_log" -eq 1 ]]; then
  LOG_DIR="${DM_LOG_DIR:-$LOG_DIR_DEFAULT}"
  mkdir -p "$LOG_DIR"
  ts="$(date +%Y%m%d-%H%M%S)"
  cmd_slug="$(printf "%s-" "$@" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '-' | sed 's/^-//;s/-$//')"
  log_file="$LOG_DIR/auto-${cmd_slug:-run}-${ts}.log"
  echo "ℹ️  Logs: $log_file" >&2
  "$PYTHON_BIN" "$SCRIPT_DIR/tools/automation/cli.py" "$@" 2>&1 | tee "$log_file"
  exit "${PIPESTATUS[0]}"
fi

exec "$PYTHON_BIN" "$SCRIPT_DIR/tools/automation/cli.py" "$@"
