# docker-compose.prod.yml - 운영 환경 특화 설정
# 이 파일은 기본 docker-compose.yml 파일 위에 추가/변경할 설정을 정의합니다.
# 'docker-compose -f docker-compose.yml -f docker-compose.prod.yml up' 명령어로 실행하며,
# 동일한 서비스에 동일한 속성이 정의된 경우, 이 파일(prod.yml)의 내용이 우선 적용(override)됩니다.

services:
  # Spring Boot Application - 운영용
  # 기본 yml 파일에는 없던 애플리케이션 서비스를 '추가'합니다.
  app:
    build: ./backend # './backend' 디렉토리의 Dockerfile을 사용하여 애플리케이션 이미지를 빌드합니다.
    container_name: dorm_app # 컨테이너에 고정 이름을 부여합니다.
    expose:
      - "8080" # 동일 네트워크(proxy, frontend)에서 접근할 수 있도록 내부 포트만 노출합니다.
    depends_on:
      # 서비스 시작 순서를 제어합니다.
      db:
        condition: service_healthy # db 서비스가 'healthy' 상태(healthcheck 통과)가 된 후에 app을 시작합니다. DB 연결 실패를 방지합니다.
      redis:
        condition: service_started # redis 서비스가 '시작된' 상태이면 app을 시작합니다. (기본 redis 이미지는 healthcheck가 없으므로 'started' 조건을 사용)
    environment:
      # Spring Boot 애플리케이션에 필요한 환경 변수를 주입합니다.
      # 운영 환경에서는 이 값들을 .env 파일이나 CI/CD 시스템을 통해 안전하게 주입해야 합니다.
      SPRING_PROFILES_ACTIVE: prod # Spring Boot의 실행 프로필을 'prod'로 설정합니다. `application-prod.properties` 설정을 활성화합니다.
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/${POSTGRES_DB} # DB 연결 URL. 'db'는 docker-compose 네트워크 내의 DB 서비스 이름입니다.
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-dormmate_user} # DB 사용자 이름
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-pleasesetup} # DB 비밀번호
      # JWT(JSON Web Token) 관련 보안 설정. 이 값들은 절대로 코드에 하드코딩하면 안 됩니다.
      JWT_SECRET: ${JWT_SECRET} # 토큰 서명에 사용할 비밀 키. 반드시 외부에서 주입받아야 합니다.
      JWT_EXPIRATION: ${JWT_EXPIRATION:-45000} # 토큰 만료 시간 (기본값: 45초)
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION:-300000} # 리프레시 토큰 만료 시간 (기본값: 5분)
      # CORS(Cross-Origin Resource Sharing) 설정
      APP_CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS} # 허용할 프론트엔드 출처(Origin)를 지정합니다. API 보안의 중요한 부분입니다.
      # 로깅 및 시간대 설정
      LOG_LEVEL: ${LOG_LEVEL:-info} # 로그 레벨을 설정합니다. 운영에서는 보통 info 레벨을 사용하며, json 형식으로 출력하여 로그 수집 시스템(ELK, Splunk 등)에서 파싱하기 용이하게 합니다.
      TZ: UTC # 컨테이너의 시간대를 UTC로 고정합니다. 서버 시간대는 전 세계 어디서든 일관성을 유지하기 위해 UTC를 사용하는 것이 표준입니다.
    restart: unless-stopped # 컨테이너가 비정상 종료 시, 사용자가 직접 중지하지 않는 한 자동으로 재시작하여 서비스 가용성을 높입니다.
    healthcheck:
      # Spring Boot Actuator가 제공하는 health check 엔드포인트를 호출하여 서비스의 실제 건강 상태를 확인합니다.
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"] # '/healthz' 엔드포인트에 요청을 보내고, HTTP 상태코드가 2xx가 아니면 실패로 간주합니다.
      interval: 10s # 10초마다 검사
      timeout: 5s # 5초 내 응답이 없으면 실패
      retries: 3 # 3번 연속 실패 시 'unhealthy' 상태가 됨
      start_period: 10s # 컨테이너 시작 후 10초만 유예합니다. 빠른 상태 전이를 위해 축소된 값입니다.

  # Next.js Frontend - 운영용
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_BASE: ${NEXT_PUBLIC_API_BASE:-http://localhost:8080/api}
        NEXT_PUBLIC_FIXTURE: ${NEXT_PUBLIC_FIXTURE:-0}
    container_name: dorm_frontend
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_BASE: ${NEXT_PUBLIC_API_BASE:-http://localhost:8080/api}
      NEXT_PUBLIC_FIXTURE: ${NEXT_PUBLIC_FIXTURE:-0}
      NEXT_TELEMETRY_DISABLED: "1"
    depends_on:
      app:
        condition: service_healthy
    expose:
      - "3000"
    restart: unless-stopped

  # HTTP Reverse Proxy - 프런트/백엔드 통합 진입점
  proxy:
    image: nginx:1.27-alpine
    container_name: dorm_proxy
    depends_on:
      app:
        condition: service_healthy
      frontend:
        condition: service_started
    ports:
      - "${PROXY_HTTP_PORT:-8080}:80" # HTTP 기본 8080(로컬)/80(운영)
      - "${PROXY_HTTPS_PORT:-8443}:443" # HTTPS 기본 8443(로컬)/443(운영)
    environment:
      SERVER_NAME: ${SERVER_NAME:-_}
      ENABLE_TLS: ${ENABLE_TLS:-false}
      TLS_DOMAIN: ${TLS_DOMAIN:-}
      TLS_SELF_SIGNED: ${TLS_SELF_SIGNED:-true}
    command: ["/bin/sh", "/etc/nginx/entrypoint.sh"]
    volumes:
      - ./deploy/nginx/templates:/etc/nginx/templates:ro
      - ./deploy/nginx/entrypoint.sh:/etc/nginx/entrypoint.sh:ro
      - certbot-www:/var/www/certbot
      - letsencrypt:/etc/letsencrypt
    restart: unless-stopped

  certbot:
    image: certbot/certbot:latest
    container_name: dorm_certbot
    profiles:
      - certbot
    volumes:
      - certbot-www:/var/www/certbot
      - letsencrypt:/etc/letsencrypt

  # PostgreSQL - 운영용 보안 강화
  # 기본 yml의 'db' 서비스 설정을 '덮어씁니다'.
  db:
    restart: unless-stopped # 운영 중 DB가 다운되면 안 되므로, 자동 재시작 정책을 추가합니다.
    environment:
      TZ: UTC # DB 서버의 시간대도 UTC로 통일하여 데이터 정합성을 보장합니다.
    # 포트 노출 없음 (내부 네트워크만 사용)
    # prod 파일에서는 'ports' 설정을 추가하지 않습니다. 이렇게 하면 DB 포트가 외부에 노출되지 않고,
    # 오직 docker-compose 네트워크 내부의 서비스(app 등)만 'db:5432'로 접근할 수 있게 되어 보안이 강화됩니다.

  # Redis - 운영용 보안 강화
  # 기본 yml의 'redis' 서비스 설정을 '덮어씁니다'.
  redis:
    restart: unless-stopped # 운영 환경의 Redis에도 자동 재시작 정책을 추가합니다.
    # 포트 노출 없음 (내부 네트워크만 사용)
    # DB와 마찬가지로 외부에 포트를 노출하지 않아 보안을 강화합니다.

  # pgAdmin - 운영용에서는 제거하거나 제한적 접근
  # 기본 yml의 'pgadmin' 서비스 설정을 '덮어씁니다'.
  pgadmin:
    # 운영환경에서는 보안상 위험이 될 수 있는 DB 관리 도구를 비활성화하는 것이 좋습니다.
    # 'profiles'는 특정 프로필이 활성화될 때만 서비스를 실행하도록 하는 기능입니다.
    # 여기에 'disabled'와 같이 의도적으로 존재하지 않는 프로필을 지정하여, 기본적으로 이 서비스가 실행되지 않도록 합니다.
    profiles:
      - disabled

  # Flyway - 운영용 안정성 강화
  # 기본 yml의 'migrate' 서비스 설정을 '덮어씁니다'.
  migrate:
    restart: "no" # 마이그레이션은 배포 시 '한 번만' 성공적으로 실행되면 충분합니다. 실패 시 재시작하는 'unless-stopped'와 달리, 'no'는 자동 재시작을 하지 않아 의도치 않은 재실행을 방지합니다.
    environment:
      TZ: UTC # 마이그레이션 스크립트 실행 환경의 시간대도 UTC로 통일합니다.
