# DormMate 기능 인벤토리
*용도: DormMate 서비스의 기능·정책·용어를 모듈별로 정리한 기준 문서로, MVP에 포함되지 않은 확장 요구나 애매한 정책을 검토할 때 참고한다. 구현 일정·우선순위는 `docs/mvp-scenario.md`와 `docs/mvp-implementation-plan.md`를 따른다.*

> **문서 사용 가이드**
> - 각 섹션은 특정 모듈의 기능 정의를 다룬다
> - 구현과 MVP 범위는 `docs/mvp-scenario.md`를 참고한다.
> - 확장 및 Phase2 아이디어는 각 섹션의 **확장** 표기를 확인한다.

## 1. 계정 및 권한

### 개요
- DormMate는 거주자, 층별장, 관리자 3개 역할을 지원한다.
- 계정 관리는 Band 톡 등 외부 시스템과 연계할 여지를 남겨두되, 기본 인증/세션은 서비스 내부에서 처리한다.

### 핵심 정책
- **회원가입**: 호실 번호 + 개인 번호 조합으로 가입한다. 1인실은 개인 번호 1 고정이며, 관리자 승인을 받을 때까지 대기 상태를 유지한다.
- **로그인/세션**: 아이디는 대소문자 구분 없이 처리하고 세션은 7일 유지한다. 비밀번호 변경 시 기존 세션은 모두 무효화한다. *(MVP 데모 한정)* 데모 이후 계정 관리 고도화 일정에 맞춰 아이디 대소문자 구분을 재도입한다.
- **탈퇴**: 계정은 비활성화 처리하고 물품 이력은 보존한다. 탈퇴 직후 로그인은 불가해야 하며, 다른 모듈에서 이력 조회는 가능해야 한다.
- **접근 제어**:  
  - 거주자: 배정된 칸 및 본인 물품만 접근 가능  
  - 층별장: 거주자 중에서 선발되며, 담당 층의 전체 칸을 관리할 수 있는 추가 권한을 갖는다.  
  - 관리자: 전역 접근, 역할 변경 권한 보유
- **알림 설정**: 사용자별로 임박, 검사 결과 등 알림 종류와 백그라운드 수신 여부를 토글할 수 있다. 실패 로그만 저장하며 재시도는 수동으로 진행한다.

### 참고 자료
- 데이터 모델 및 역할 매핑: `docs/data-model.md`
- 관련 테스트 기준: `AUTH-01`

---

## 2. 냉장고 – 일반 기숙사생

### 용어
- **포장(FridgeBundle)**: 냉장고 스티커 1개에 대응하는 단위. 여러 물품을 포함한다.
- **물품(FridgeItem)**: 포장 내부의 개별 품목.
- **스티커 번호**: 거주자가 스티커에 기입하는 3자리 숫자. UI는 칸 순번(`slot_index`)을 문자(A/B/C…)로 변환해 `A123` 형태로 보여 주지만, 서버에는 칸 ID와 3자리 숫자만 저장한다.
- **칸 할당**: 기본 구성은 냉장 3칸·냉동 1칸이며, 접근 권한을 위해 냉장 칸마다 8호실씩(24 ÷ 3)을, 냉동 칸에는 24호실 전체를 공용으로 매핑한다. **포장 허용량은 라벨 범위(기본 001~999) 또는 관리자 설정 `max_bundle_count`로 결정**되며, 호실 수와는 별도로 조정할 수 있다.

### 기능 정의
- **칸 선택**: 사용자에게 배정된 냉장/냉동 칸만 선택 가능하다. 가용 포장 수를 초과하면 등록을 제한한다.
- **포장 등록**: 장바구니 형태로 물품 이름/수량/유통기한/메모를 입력한다. 저장 시 칸 허용량(`max_bundle_count`)을 검사하고 해당 칸의 라벨 시퀀스에서 3자리 번호를 자동 발급한다. 기본 허용량은 라벨 범위(001~999)이며, 데모 시나리오에서는 설명을 위해 특정 칸만 3개로 제한한다. 포장 메모는 작성자만 열람한다.
- **포장/물품 관리**:  
  - 포장: 포장명·메모 수정 가능, 스티커 번호/등록일시는 수정 불가  
  - 물품: 이름·유통기한·수량 수정, 소프트 삭제 후 라벨 재사용 가능  
  - 포장 전체 삭제 가능
- **조회/검색**: 최신순 목록 제공, D-3 이하 임박은 노란 배지, 만료는 빨간 배지로 표시한다. 품목/포장명 검색과 “칸 선택 + 3자리 번호 입력” 방식의 스티커 검색을 지원한다.
- **미등록 물품 처리**: 검사자가 발견한 미등록 물품은 간단 등록 후 즉시 폐기한다. 통계에는 “미등록 폐기”로만 집계하며 추가 알림은 발송하지 않는다.
- **접근 제한**: 타인 포장 수정·삭제 시 403을 반환하고, 검사 중인 칸/포장은 잠금 상태로 표시해 수정할 수 없다.
- **검사 이후 처리**: 검사 후 수정된 물품은 별도 필터로 확인할 수 있다.

### 참고 자료
- 데이터 모델: `docs/data-model.md` §4.1~§4.2
- 관련 테스트 기준: `FRIDGE-02`

---

## 3. 냉장고 – 알림 & 일정

### 목적
- 층별장 검사를 비롯해 물품 임박/만료 정보를 거주자에게 전달하고, 냉장고 일정 정보를 공유한다.

### 주요 정책
- **검사 결과 알림**: 층별장이 검사 제출 시 경고/폐기 대상 거주자에게 즉시 발송한다. 동일 세션/사용자 조합은 중복 발송하지 않는다.
- **임박/만료 알림**: 매일 09:00 배치로 생성하며 하루 1회만 전달한다. 임박은 3일 이내, 만료는 이미 지난 물품을 요약한다.
- **알림 UX**: 알림 목록은 미읽음을 상단에, 읽음을 하단에 배치한다. 냉장고 메인 진입 시 관련 알림은 자동으로 읽음 처리되며, 24시간 후 만료·자동 제거된다. 알림 설정에서 종류별 ON/OFF와 백그라운드 허용 옵션을 제공한다.
- **검사 일정**: 다음 검사일 정보를 `/fridge/inspections`에서 제공하고, 일정 저장소는 서버에서 관리한다.


---

## 4. 냉장고 – 층별장(검사자)

### 역할
- 층별장은 담당 층의 냉장고 검사를 수행하고, 검사 결과를 기록·전파한다.  
- **확장**: 다중 검사자 합류(최대 2인)와 실시간 동기화는 차기 단계에서 도입한다.

### 기능 정의
- **검사 세션**: 담당 층 칸만 검사 시작 가능하며, 세션 생성 시 해당 칸을 잠금 상태로 전환한다. *(MVP: 단독 검사 기준)*  
- **확장**: 동일 칸 검사 중일 경우 “검사 합류”로 참여(최대 2인)하고 SSE 기반으로 조치 결과를 공유한다. 네트워크 문제 시 단독 검사 플로우로 전환하는 폴백 전략을 마련한다.
- **검사 화면**: “검사 전” / “검사 완료” 탭 구조를 유지하고, 만료 물품·검사 후 수정됨 필터와 포장/물품 검색을 제공한다.
- **임시 저장**: 검사자는 현재 기기에서 자동 저장(로컬 스토리지)으로 복원되며, 필요 시 수동 저장 버튼도 동일한 로컬 Draft에 기록한다. 다중 검사자 동시 편집을 지원해야 할 때 서버 Draft API로 이 구조를 이관하며, 그 전까지는 서버 저장을 시도하지 않는다.
- **조치 유형**:  
  - 경고: `WARN_INFO_MISMATCH`(정보와 실제 보관 불일치), `WARN_STORAGE_POOR`(포장 상태 불량)  
  - 폐기: `DISPOSE_EXPIRED`(유통기한 경과 폐기)  
  - 통과: `PASS`  
  - 미등록 물품 즉시 등록 + 폐기: `UNREGISTERED_DISPOSE` (미등록 품목명 필수 기록)  
  - 기타: `reason_code`를 비워두고 자유 메모(`free_note`)에 세부 사유를 남긴다.  
- **검사 제출**: “검사 전” 탭이 비어야 제출 가능하다. 제출 시 검사자·일시·칸·조치 내역을 저장하고, 경고/폐기/총 포장 등 통계를 집계한 뒤 관련 거주자에게 알림을 발송한다. 세션 종료 후 칸 잠금을 해제한다.
- **검사 이력**: 층/검사자/기간 필터를 제공하고, 상세 페이지에서 조치 내역을 확인할 수 있다.
- **역할 전환**: 층별장 임명/해제는 기존 거주자 계정을 승격/복귀시키는 방식으로 처리하며, 임명 시 즉시 추가 권한이 부여되고 해제 시 일반 거주자 권한만 남는다. 진행 중 검사 세션이 있다면 안전하게 종료하거나 다른 층별장에게 승계한다.

---

## 5. 냉장고 – 관리자

### 역할
- 전체 냉장고 운영 상황을 모니터링하고, 층별장 임명/해제, 물품 관리, 자원 재배치 등을 담당한다.

### 기능 정의
- **현황 대시보드**: 등록 물품(층/칸별), 임박 물품, 주간 검사 횟수/조치, 활성 사용자 수, 알림 발송 현황 등을 제공한다.
- **역할 관리**: 층별장 임명/해제를 즉시 반영하고, 해제 시 진행 중인 검사를 안전하게 종료한다.
- **물품 관리**: 전체 물품 조회(층/칸/호실/상태/검색/페이지네이션), 강제 수정·삭제(사유 입력 후 알림), 일괄 처리 기능을 제공한다.
- **검사 이력**: 층, 검사자, 기간 기반 필터 및 상세 조회를 지원하며, CSV 내보내기 옵션을 고려한다.
- **사용자 관리**: 사용자 목록(호실/이름/이메일/역할) 확인, 역할 변경, 계정 비활성화(퇴사자 등) 수행.
- **자원·알림 설정**:  
  - 알림 배치 시각 설정과 테스트 발송  
  - `notification_policy` 기반 정책 관리(TTL, 일일 발송 상한, 백그라운드 기본값)  
  - 냉장고 자원 관리(유닛/칸 상태 전환 `ACTIVE/SUSPENDED/REPORTED/RETIRED`, 라벨 범위/호실 재배분, 냉장고 추가/삭제)
- **시스템 모니터링**: CPU/메모리/디스크, API 응답 시간, 최근 100건 에러 로그를 확인할 수 있는 뷰를 제공한다.
- **벌점 제재 통보**: 벌점 기준치를 초과한 사용자에게 DormMate 알림으로 이용 제한 모듈을 통보한다.

---

## 6. 공통 시스템 정책

### 알림 피로도 관리
- 모듈별 하루 최대 발송 건수를 2건으로 제한한다.
- Band 공지와 중복되지 않도록 dedupe 키를 적용한다.
- 사용자에게 백그라운드 알림 허용 여부를 항상 제공한다.

### 상벌점 및 감사
- 자동 벌점: 도서관 연체(1일 1점)  
- 수동 벌점: 다목적실 노쇼(2점), 세탁실 방치(1점)  
- 누적 10점 이상 시 세탁실·다목적실·도서관 이용을 1주일간 제한하고 DormMate 알림으로 안내한다. 냉장고 기능은 유지한다.
- 모든 예약/대출/사용 기록에 감사 로그를 남겨 분쟁 시 증빙으로 활용한다.

### Band 연동
- 공식 공지(임명, 검사 결과 등)는 Band에 우선 게시하고, DormMate는 개인 맞춤 알림·내역 관리에 집중한다. 자동 동기화는 후순위로 둔다.

### 접근 제어 공통 원칙
- 역할별 권한을 명확히 분리하고, 모듈 확장 시 권한 매핑을 문서화한다.
- 인증/인가 로직 변경 시 OpenAPI 및 데이터 모델을 함께 갱신한다.

---

## 7. Phase 2 모듈 개요 (참고)

Phase 2에서는 세탁실, 도서관, 다목적실 등 추가 모듈을 도입해 DormMate의 공용 시설 관리 기능을 확장한다. 이 절은 정책 초안을 요약하며, 구체적인 구현 범위는 추후 별도 문서로 분리한다.

### 7.1 세탁실
- **핵심 시나리오**: 기기 예약·사용·종료 알림, 타인 기기 사용 중 행동(메시지, 남은 시간 수정), 미수거 처리, 고장 신고.
- **정책**: 종료 5분 전 알림, 남은 시간 정정(±10분), 미등록 사용자의 간편 등록, 관리자 고장 처리 및 사용 통계 관리.

### 7.2 도서관
- **핵심 시나리오**: 도서 검색/대출/반납/예약, 연장 요청, 연체 관리.
- **정책**: 반납 5일 전/당일 알림, 연체 시 매일 알림, 예약 가능/만료 알림, 예약 만료에도 벌점은 부과하지 않는다.

### 7.3 다목적실
- **핵심 시나리오**: 10분 단위 슬롯 예약, 합석 옵션, 노쇼 신고 처리.
- **정책**: 예약 시작/종료 10분 전 알림, 노쇼 신고 시 관리자 확인 후 벌점, 강제 예약/취소 권한.

### 7.4 공통
- 하루 알림 제한, Band 중복 제거, 상벌점/감사 로그 연동은 Phase 2 모듈에도 동일하게 적용한다.

---
## 8. 알림 체계 요약 (Must)
### 8.1 채널 및 동작
- **채널**: PWA 푸시(가능한 무음 방지), 메인 화면 상태 카드, 종 모양 알림 목록, 하단 탭 배지.
- **읽음 규칙**: 관련 화면/팝업 진입 시 자동 읽음 처리, 24시간 경과 시 자동 만료 가능. 미읽음 상태일 때만 배지/아이콘 활성화.
- **Band 연동**: 임명/공지 등 공식 안내는 Band에 우선 게시, DormMate는 개인 맞춤 알림·내역 관리에 집중.


### 8.2 모듈별 알림 정책

| 모듈 | 주요 알림 | 
|---|---|
| 세탁실 | 종료 5분 전, 상태 변경(관리/고장 신고), 남은 시간 정정, 메시지 도착 |
| 냉장고 | 유통기한 임박·만료(09:00 묶음), 검사 결과(경고/폐기/벌점), 검사 일정 변경 |
| 도서관 | 반납 5일 전/당일, 연체, 예약 대출 가능, 예약 만료 자동 취소(벌점 없음) |
| 다목적실 | 시작/종료 10분 전, 노쇼 신고 (미등록 신고는 Band 처리) |
| 시스템/관리 | 상·벌점 변동, 계정 승인 등 최소 공지 |

### 8.3 PWA 푸시 템플릿

| 제목 예시 | 본문 예시 |
|---|---|
| `[세탁실] {기기명} 종료 5분 전` | 곧 사용이 끝납니다. 수거를 준비해주세요. |
| `[세탁실] {기기명} 사용 종료` | 기기 사용이 종료됐습니다. 세탁물을 회수해주세요. |
| `[세탁실] {기기명} 메시지` | {보낸이}님의 요청을 확인해주세요. |
| `[세탁실] {기기명} 상태 변경` | 기기 상태가 {상태}로 전환되었습니다. 상세를 확인해주세요. |
| `[세탁실] {기기명} 종료 시간 조정` | 종료 예정 시간이 {종료시간}로 변경되었습니다. |
| `[다목적실] {방번호} 시작 10분 전` | {시작시각} 예약이 곧 시작됩니다. 준비해주세요. |
| `[다목적실] {방번호} 종료 10분 전` | 정리 후 퇴실을 준비해주세요. |
| `[다목적실] {방번호} 예약 취소` | 관리자에 의해 예약이 취소되었습니다. |
| `[다목적실] {방번호} 노쇼 신고` | 입력된 예약이 사용되지 않았다는 신고가 접수되었습니다. |
| `[도서관] 반납 5일 전` | {권수}권 반납 또는 연장을 진행해주세요. |
| `[도서관] 반납 당일` | {권수}권 반납이 오늘 마감됩니다. |
| `[도서관] 연체 발생` | 대출 도서가 연체되었습니다. 즉시 반납해주세요. |
| `[도서관] 예약 도서 이용 가능` | {권수}권을 5일 동안 대출할 수 있습니다. |
| `[도서관] 예약 기한 오늘까지` | {권수}권 예약 대출이 오늘까지 가능합니다. |
| `[도서관] 예약 자동 취소` | 대출 기한이 만료되어 예약이 자동 취소되었습니다. |
| `[냉장고] 점검 결과 알림` | 경고 {개수}건, 폐기 {개수}건이 발생했습니다. 확인해주세요. |
| `[냉장고] 유통기한 임박` | {개수}개 품목의 유통기한이 임박했습니다. |
| `[냉장고] 유통기한 경과` | {개수}개 품목의 유통기한이 지났습니다. 폐기해주세요. |
| `[시스템] 상·벌점 변동` | {사유}로 {변동점수}점이 반영되었습니다. 현재 {총점}점입니다. |

### 8.4 종 모양 알림 문구 예시
- `관리자로부터 상점 3점을 받았습니다.` / `'세탁물 방치' 사유로 벌점 1점을 받았습니다.`
- `최고 관리자가 회원님의 관리자 계정을 승인했습니다.`
- `'세탁기 1'의 작동이 5분 뒤 완료됩니다.`
- `다른 사용자가 '건조기 2'의 남은 시간을 수정했습니다.`
- `다른 사용자에게 '세탁기 1'번에서 '기다리고 있어요' 요청이 도착했습니다.`
- `사용 중인 '건조기 1'의 상태가 '고장 신고'로 변경되었습니다.`
- `'계란' 외 3개 물품의 유통기한이 5일 남았습니다.`
- `점검 결과, 회원님의 물품 1개가 '폐기' 처리되었습니다.`
- `'JPA 프로그래밍' 외 1권의 반납일이 5일 남았습니다.`
- `대출하신 '데이터베이스' 도서가 연체되었습니다.`
- `예약하신 '토비의 스프링' 도서 대출이 가능합니다.`
- `예약하신 '토비의 스프링' 도서가 대출 기한 만료로 자동 취소되었습니다.`
- `예약하신 '스터디룸 A'의 사용 시작 10분 전입니다.`
- `사용 중인 '스터디룸 A'의 종료 10분 전입니다.`
- `예약 도서의 대출 기한이 만료되어 자동 취소되었습니다.` (벌점 없음 안내)

### 8.5 탭 배지 규칙
- **값**: 미읽음 수(최대 9+), 점 표시 허용.
- **규칙**: 관련 화면 진입 시 소거, 24시간 경과 시 자동 만료 가능.
- **냉장고 탭**: 임박 묶음은 매일 09:00 1회 생성 후 확인 시 소거, 폐기 알림은 해결 전까지 유지.
- **도서관 탭**: 임박·당일·예약 가능 묶음은 09:00 생성 후 확인 시 소거, 연체는 해결 전까지 유지.
- **메인 화면**: 당일 예약된 다목적실(가장 빠른 시작 시간)과 사용 중 또는 알림 신청된 세탁실 기기 정보를 카드·팝업으로 제공.


### 8.6 중복 방지 키(dedupe)·TTL 규칙

| `kind_code` | `dedupe_key` 포맷 | 기본 `ttl_at` | 비고 |
|---|---|---|---|
| `FRIDGE_EXPIRY` | `FRIDGE_EXPIRY:{userId}:{yyyyMMdd}` | 생성 시각 + 24시간 | 매일 09:00 임박 배치. 다음날 배치가 같은 키를 사용해 중복 생성 방지. |
| `FRIDGE_EXPIRED` | `FRIDGE_EXPIRED:{userId}:{yyyyMMdd}` | 생성 시각 + 24시간 | 만료 묶음 배치. 해결 전까지 탭 배지는 유지하되, 알림 레코드는 하루 뒤 정리. |
| `FRIDGE_RESULT` | `FRIDGE_RESULT:{sessionUuid}:{userId}` | 생성 시각 + 7일 | 검사 제출 즉시 발송. 같은 세션+사용자는 중복 알림 금지. |
| `LAUNDRY_EVENT` | `LAUNDRY_EVENT:{machineId}:{eventUuid}` | 생성 시각 + 6시간 | 종료 임박/시간 정정/메시지 등 단기 이벤트. 이벤트 UUID는 도메인 서비스에서 생성. |
| `ROOM_PENALTY` | `ROOM_PENALTY:{userId}:{penaltyHistoryId}` | 생성 시각 + 30일 | 벌점/상점 기록 공지. 만료 전에도 사용자가 읽음 처리 가능. |
| 기타 | `{KIND}:{businessKey}` | 정책에 따라 설정 | 신규 kind 추가 시 동일 표에 항목을 추가하고 OpenAPI 예시를 갱신한다. |
