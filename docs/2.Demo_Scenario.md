# DormMate 냉장고 MVP 시연 시나리오
*이번 배포/데모에서 반드시 보여 줄 사용자 흐름과 정책을 정리한 기준 문서입니다. 모든 설명은 현재 구현(2025-11)과 동기화되어 있습니다.*

## 1. 데모 목표
- 라벨 자동 발급, 검사·벌점·알림 파이프라인, 관리자 통제를 10분 이내에 연속 시연한다.
- “거주자 → 층별장 → 관리자” 순으로 단일 데이터가 흐른다는 점을 강조한다.
- 실서비스와 동일한 prod 프로파일(+실제 DB/Redis) 환경에서 데모를 진행해 신뢰를 확보한다.

## 2. 사전 준비

### 2.1 환경 체크리스트
> 기본값은 dev/db=`local`, deploy=`prod`이다.

- [ ] 발표 서버에서 `./auto deploy up --build --env prod` 실행 (문제 시 `./auto deploy reset --build --env prod`로 한 번에 초기화)
- [ ] `deploy/.env.prod` 최신 비밀 값 적용, 필요 시 `ENABLE_TLS=true`+도메인 설정 후 certbot 발급
- [ ] 로컬 환경에서 직접 백엔드를 띄울 경우 `./auto dev backend --env local`로 실행(CORS 등 env 동기화)
- [ ] `./auto deploy status --env prod`, `curl http://localhost:8080/healthz`, `curl http://localhost:8080/frontend-healthz`로 백엔드/프런트 헬스 확인

### 2.2 계정·데이터 체크리스트
- [ ] 계정 준비: 거주자 `313-1`, 보조 `313-2`, 층별장 `floor_mgr_3f`, 관리자 `admin`
- [ ] 칸 배정표 인쇄 혹은 슬라이드 준비 (냉장 1~3번 / 냉동 1칸)
- [ ] `/admin/seed/fridge-demo` 실행 후 `전시 데모:` 데이터 재주입 (운영 DB 금지)
- [ ] 샘플 검사 1건 실행(폐기 1 + 경고 1) → 알림/정정 테스트용 데이터 확보
- [ ] 필요 시 `POST /fridge/inspections/{id}/actions`로 벌점/폐기 데이터를 미리 추가

### 2.3 장비·네트워크 체크리스트
- [ ] 노트북 1대 + HDMI, 듀얼 모니터(선택) 준비
- [ ] 관리자/층별장/거주자 3개 브라우저 창(층별장은 시크릿 모드) 로그인 상태 유지
- [ ] 멀티 로그인/세션 만료 안내 메시지 사전 점검
- [ ] 네트워크 Failover 대비 로컬 Docker Compose Up 여부 확인

### 2.4 자동화 명령 요약
- `./auto db migrate` : Flyway 마이그레이션 적용 (필요 시 `--repair`)
- `./auto deploy up --build` : 최신 컨테이너 빌드·기동
- `./auto deploy reset --build` : down --volumes → db/redis → migrate → up 순으로 초기화
- `./auto deploy tls issue|renew` : HTTPS 인증서 발급/갱신 (도메인 사용 시)

## 3. 시연 흐름

### 🚀 DormMate: 최종 시연 시나리오 (A+B)

#### 1단계: 칸 용량·라벨 발급·관리자 증량
> 목표: 현재 허용량에서 등록 실패 → 관리자 증량 → 라벨 발급/삭제/재사용 → 잘못된 하향 차단까지 확인.  
> 핵심 API/검증: `GET /fridge/slots?view=full`(용량/점유/잠금), `POST /fridge/bundles`(422 `CAPACITY_EXCEEDED`), `PATCH/DELETE /fridge/bundles/{id}`(라벨 재사용), `PATCH /admin/fridge/compartments/{id}`(422 `CAPACITY_BELOW_ACTIVE`).

* [페르소나] 거주자(A) / 관리자(C)
* 멘트: "슬롯 리스트에서 `maxBundleCount`와 `occupiedCount`를 확인합니다. 허용량을 넘겨 등록하면 422 `CAPACITY_EXCEEDED`가 떨어집니다. 관리자가 `/admin/fridge/compartments/{id}`로 허용량을 늘리면 바로 성공하며, 삭제한 포장은 다음 등록 시 같은 3자리 라벨이 재사용됩니다. 허용량을 활성 포장 수보다 낮게 내리면 422 `CAPACITY_BELOW_ACTIVE`로 막힙니다."

#### 2단계: 검사 시작·잠금
> 목표: 세션 생성과 칸 잠금 흐름 확인.  
> 핵심 API/검증: `POST /fridge/inspections`(201), `GET /fridge/inspections/active`, 30분 잠금 + 5분 주기 만료 정리.

* [페르소나] 층별장(B)
* 멘트: "검사 시작을 누르면 세션이 생성되고 칸이 30분 동안 잠깁니다. 활동이 없으면 5분마다 만료된 잠금을 정리해 무한 잠금을 막습니다. 필요하면 `DELETE /fridge/inspections/{id}`로 취소해 일정 상태를 되돌릴 수 있습니다."

#### 3단계: 잠금 중 거주자 차단
> 목표: 잠금/검사 중 거주자 수정 차단.  
> 핵심 API/검증: `POST /fridge/bundles` 등 → 423 `COMPARTMENT_LOCKED` 또는 `COMPARTMENT_UNDER_INSPECTION`.

* [페르소나] 거주자(A)
* 멘트: "검사 중인 칸은 UI에서 버튼이 비활성화되고, API로 직접 등록을 시도해도 423 `COMPARTMENT_LOCKED`/`COMPARTMENT_UNDER_INSPECTION`가 내려옵니다."

#### 4단계: 조치·벌점·잠금 연장
> 목표: 조치 기록과 자동 벌점, 잠금 연장 동작.  
> 핵심 API/검증: `POST /fridge/inspections/{id}/actions` → `inspection_action_item` 스냅샷, 폐기/미등록 폐기 시 `penalty_history` 1점, 잠금 30분 연장.

* [페르소나] 층별장(B)
* 멘트: "폐기(DISPOSE)나 미등록 폐기 시 스냅샷이 저장되고 벌점 1점이 자동 적재됩니다. 경고는 기록만 남고 벌점 없음. 조치 성공 시 잠금이 30분 연장됩니다."

#### 5단계: 제출·알림·검사 후 수정 배지
> 목표: 제출 후 알림 발송과 수정 배지 반영.  
> 핵심 API/검증: `POST /fridge/inspections/{id}/submit` → `NotificationService.sendInspectionResultNotifications`(dedupe `FRIDGE_RESULT:<session>:<user>`), `/notifications` 목록·읽음, `updatedAfterInspection` 배지.

* [페르소나] 층별장(B) / 거주자(A)
* 멘트: "제출하면 즉시 거주자에게 검사 결과 알림이 도착하고, dedupe 키로 중복 발송을 막습니다. 제출 뒤 거주자가 포장을 수정하면 `updatedAfterInspection` 배지가 표시돼 사후 수정 여부를 식별할 수 있습니다."

#### 6단계: 권한 불일치 모니터링
> 목표: 소유자-호실-칸 매핑 오류 탐지.  
> 핵심 API/검증: `GET /admin/fridge/issues`(뷰 `vw_fridge_bundle_owner_mismatch`)로 리스트, issueType별 조치.

* [페르소나] 관리자(C)
* 멘트: "권한 불일치 모니터에서 `ROOM_NOT_ALLOWED_FOR_COMPARTMENT`나 `NO_ACTIVE_ROOM_ASSIGNMENT`를 찾아 즉시 재배분/회수를 진행합니다. 뷰는 repeatable Flyway 스크립트로 유지됩니다."

#### 7단계: 운영 도구(재배분·정정)
> 목표: 재배분/정정과 감사 로그 확인.  
> 핵심 API/검증: `POST /admin/fridge/reallocations/preview|apply`(검사 중이면 거절), `PATCH /fridge/inspections/{id}` 정정, AuditLog `FRIDGE_REALLOCATION_APPLY`.

* [페르소나] 관리자(C)
* 멘트: "재배분 프리뷰/적용으로 호실 배정을 다시 계산합니다. 검사 중 칸이 포함되면 전체 요청이 거절되므로 `/fridge/inspections/active`로 먼저 확인합니다. 필요하면 검사 내역을 정정(PATCH)해 벌점/조치를 수정할 수 있고, 모든 작업이 감사 로그에 남습니다."

#### 8단계: 배치 알림·감사 추적
> 목표: 임박 알림 배치와 감사 로그.  
> 핵심 API/검증: `FridgeExpiryNotificationScheduler`(매일 09:00) → `notification_dispatch_log`, AuditLog `INSPECTION_SUBMIT` 등.

* [페르소나] 관리자(C)
* 멘트: "매일 9시에 임박/만료 알림 배치가 돌고, 성공/실패는 `notification_dispatch_log`에 기록됩니다. 제출/정정/재배분/시드 실행 등 모든 민감 이벤트는 AuditLog로 추적됩니다."

#### 9단계: 데모 리셋
> 목표: 데모 데이터 초기화 및 감사 로그 남김.  
> 핵심 API/검증: `POST /admin/seed/fridge-demo` → `FRIDGE_DEMO_SEED_EXECUTED`.

* [페르소나] 관리자(C)
* 멘트: "시연 종료 후 `/admin/seed/fridge-demo`로 데이터를 초기화하고, 실행 기록은 감사 로그에 남습니다."

#### 10단계: 멀티 로그인 · deviceId 검증
> 목표: 편의+보안 균형.  
> 핵심 API/검증: `POST /auth/login`, `POST /auth/refresh` → `DEVICE_MISMATCH` (access 45초, refresh 5분 기본).

* [페르소나] 거주자(A)/층별장(B)
* 멘트: "멀티 로그인은 허용하지만 refresh 시 deviceId 불일치가 감지되면 `DEVICE_MISMATCH`로 세션을 폐기합니다. 로컬 스토리지 `dm.device.id`를 다르게 두고 refresh 토큰만 다른 브라우저에 붙여 넣으면 바로 재현됩니다."
