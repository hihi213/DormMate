# DormMate 냉장고 MVP 시연 시나리오
*이번 배포/데모에서 반드시 보여 줄 사용자 흐름과 정책을 정리한 기준 문서입니다. 모든 설명은 현재 구현(2025-11)과 동기화되어 있습니다.*

## 1. 데모 목표
- 라벨 자동 발급, 검사·벌점·알림 파이프라인, 관리자 통제를 10분 이내에 연속 시연한다.
- “거주자 → 층별장 → 관리자” 순으로 단일 데이터가 흐른다는 점을 강조한다.
- 실서비스와 동일한 prod 프로파일(+실제 DB/Redis) 환경에서 데모를 진행해 신뢰를 확보한다.

## 2. 사전 준비

### 2.1 환경
- 발표용 서버에 최신 이미지를 배포하고 `docker-compose.prod.yml`(app + PostgreSQL + Redis)로 기동한다.
- `deploy/.env.prod`를 최신 비밀 값으로 채워 두고, 로컬 백업본은 즉시 폐기한다.

### 2.2 계정·데이터
- **계정**: 거주자 `313-1`, 보조 거주자 `313-2`, 층별장 `floor_mgr_3f`, 관리자 `admin`.
- **칸 배정표**: 냉장 1~3번(01~08/09~16/17~24호), 냉동 1칸(전체 공용) 자료를 인쇄물/슬라이드로 준비한다.
- **데모 초기화**  
  1. 관리자 화면에서 `데모 데이터 초기화` 버튼을 눌러 `/admin/seed/fridge-demo`를 실행한다. `전시 데모:` 접두사가 붙은 포장 7건과 기본 층별장 계정이 재주입된다. (운영 DB에서는 절대 실행 금지)  
     > 수동 SQL로 데이터를 지울 경우 `inspection_action_item → inspection_action → penalty_history` 순으로 FK 참조를 먼저 삭제한 뒤 `fridge_item`/`fridge_bundle`/`bundle_label_sequence`를 정리한다. `AdminSeedIntegrationTest`도 동일 흐름을 사용하므로, 같은 순서를 따르면 데모 API 실행 전에 FK 오류를 피할 수 있다.
  2. 층별장 계정으로 샘플 검사를 한 번 실행해 **폐기 1건+경고 1건**이 포함된 검사 기록을 만든다. 이 데이터가 이후 정정·알림 재조회 시 사용된다.  
  3. 필요 시 `POST /fridge/inspections/{id}/actions`를 API 클라이언트로 호출해 폐기/벌점 데이터를 미리 채워 둘 수 있다.

### 2.3 장비·네트워크
- 노트북 1대(HDMI 출력), 브라우저 3개 창(거주자/층별장/관리자) 준비. 층별장은 시크릿 창으로 실행한다.
- 관리자 계정 로그인 → 세션 만료 안내, 다중 로그인 차단 메시지가 정상 동작하는지 사전 점검.

### 2.4 비상 플랜
- 네트워크 장애 시 로컬 Docker Compose 환경으로 전환할 수 있도록 동일 이미지를 사전 빌드.
- DB 스냅샷을 백업해 두고, 문제가 생기면 `psql < backup.sql`로 복구한다.

## 3. 시연 흐름

### 3.1 거주자 포장 등록·관리
1. 거주자 `313-1` 로그인 → `내 냉장고`. 다른 브라우저에서 동시에 로그인하면 `deviceId` 불일치로 기존 세션이 해제되는지 보여 준다.
2. `view=full` 토글로 층별 슬롯을 펼쳐 `occupiedCount`와 잔여 용량을 확인한다.
3. 배정된 칸 선택 → 포장 이름/수량/유통기한 입력 → `등록`. 자동 발급 라벨(`A123`)과 완료 토스트를 보여 준다.
4. 검색창에 포장명을 입력해 즉시 필터링한 뒤, 페이지네이션(`page`,`size`)이 정상 동작하는지 확인한다.
5. 임박/만료 배지 색상(노랑/빨강)을 예시 포장으로 강조하고, 물품 수정으로 배지 상태가 즉시 바뀌는 모습을 시연한다.
6. 메모 필드는 작성자만 확인 가능함을 보여 주고, 물품 하나를 삭제해 **라벨 재사용** 배지(관리자 화면)와 연결될 데이터를 마련한다.
7. 보조 거주자 `313-2`가 동일 칸에 포장을 추가 → 최초 계정 화면으로 돌아가 `occupiedCount`가 증가한 것을 확인한다.
8. 검사 이후 수정된 포장에는 `updatedAfterInspection` 배지가 붙는다는 점을 언급하고, 나중에 관리자 뷰에서 다시 확인할 것임을 예고한다.

### 3.2 층별장 검사 세션
1. 층별장 계정 로그인 → `검사 관리`. 대상 칸 선택 후 `검사 시작` → 칸이 `검사 중`으로 잠기고 거주자 수정 버튼이 비활성화된 것을 확인한다.
2. 조치 입력: 정상 포장은 `통과`, 임박 포장은 `경고`, 만료 포장은 `폐기`, 미등록 발견 시 `간편 등록 → 즉시 폐기`. Draft 자동 저장을 확인하고, 새로고침 후 동일 상태가 복원되는지 보여 준다.
3. 활동이 있을 때마다 잠금이 30분씩 연장되고, 무활동 시 자동 해제된다는 정책을 소개한다. 관리자만 강제 종료 가능함을 짚는다.
4. `검사 제출` → 요약 카드(경고/폐기 수) 확인, 칸 잠금 해제, Draft 삭제.
5. 제출 직후 `조치 내역` 패널에서 폐기 사유, 경고 메모, 미등록 폐기 기록을 확인하고 `inspection_action_item` 스냅샷이 벌점/알림과 연결된다는 점을 설명한다.

### 3.3 검사 정정 & 벌점/알림 검증
1. 관리자 `/admin/fridge` → 하단 `최근 검사`에서 방금 세션 선택.
2. `정정` 버튼으로 조치 하나를 수정(폐기→경고)하고 메모를 갱신한다. 저장 시 토스트(`INSPECTION_ADJUST`)와 감사 로그 기록 문구가 뜨는지 확인.
3. 정정 결과가 관리자 `삭제 이력`/거주자 포장 상세에 반영되는지 확인한다.
4. 알림 탭에서 `[냉장고] 점검 결과` 알림을 열어 `sessionId/actionIds/penaltyHistoryIds` 메타데이터가 그대로 전달됐는지 확인한다. (UI는 요약 메시지를 사용하지만, 디버그 모달에서 메타데이터를 확인)  
5. 벌점 모달을 열어 `PenaltyHistory` 1점이 누적됐는지, 정정 시 벌점이 재계산되는지 보여 준다.

### 3.4 알림 · 일정 · 배치
1. 거주자 알림 목록에서 방금 검사 알림을 읽고, `알림 설정` 화면에서 냉장고 알림 ON/OFF·백그라운드 허용을 토글한다.
2. 관리자 화면에서 `notification_dispatch_log`에 발송/실패 로그가 남았는지 확인한다.
3. 배치 알림: 오전 09:00 스케줄로 생성된 임박/만료 알림(샘플 데이터)을 소개하고, Redis dedupe 키 + 7일 TTL 정책을 설명한다.
4. 층별장 `검사 일정` 시트에서 일정 생성 → 저장 → 연결된 검사 제출 시 일정이 자동 `COMPLETED`로 바뀌는 모습을 확인한다.

### 3.5 관리자 운영 통제 & 데모 초기화
1. `/admin/fridge` 상단 도구 모음 소개: 층 필터, 슬롯 검색, `재배분`, `검사 일정`, `데모 데이터 초기화`.
2. 특정 칸 우측 패널 → `칸 설정`으로 `max_bundle_count` 값을 바꾸고, 거주자 화면에서 잔여 용량이 늘어난 것을 보여 준다.
3. `재배분` 시트를 열어 권장 배정/현재 배정을 비교하고, 잠금·검사 중 칸에 경고 뱃지가 표시되는지 확인한다.
4. `삭제 이력` 탭에서 라벨 재사용 배지, 검색·페이지네이션 동작을 시연한다.
5. Danger Zone에서 `데모 데이터 초기화`를 다시 실행하면 전시용 포장이 즉시 갱신되고 감사 로그가 남는다는 점을 보여 준다. (이때는 mock API 사용 권장)

## 4. 마무리 & 안정성 강조
- 배포 로그: Day6 스테이징 → Smoke 테스트 → Day7 프로덕션 순으로 마쳤음을 스크린샷 또는 CLI 로그로 공유.
- 운영 지표: `/actuator/health`, API 응답 시간, 오류 로그 0건을 캡처해 신뢰성을 강조.
- 롤백 플랜: 이전 이미지 재배포, Flyway 백업/복원, 데모 데이터 복구 절차를 한 장으로 정리한다.

## 5. 향후 작업
1. **실시간 합류(SSE)**: 현재는 단독 검사 + 폴링이지만, [MVP Plan IN-306](mvp-plan.md#in-306-실시간-검사-합류복구)을 기반으로 2인 합류·자동 복구를 구현할 예정.
2. **알림 딥링크**: `notification.metadata`에 이미 담긴 `sessionId/actionIds`를 활용해 UI에서 직접 검사 상세 화면으로 이동하도록 개선.
3. **관리자 일정 확장**: `/admin`에서 다층 검사 일정을 등록하고 층별장에게 알림을 보내는 흐름을 차기 목표로 설정.
4. **데모 시드 보호 장치**: prod 환경에서 `/admin/seed/fridge-demo`가 실행되지 않도록 `@Profile("!prod")` 또는 feature flag 추가.

## 부록 A. 실제 구현 근거
- **환경/런타임**
  - `deploy/.env.prod` 단일 전략, `backend/scripts/flyway.sh` 진입점, prod 기본 프로파일이 코드에 반영되어 있다.
  - `RedisConfig` 토글 및 `application.properties`의 prod 기본값 덕분에 로컬·운영이 동일 구성을 공유한다.
- **시드·감사 로그**
  - `DemoSeedService` + `db/demo/fridge_exhibition_items.sql`로 데모 데이터를 완전히 재구성하고, `AuditLogService`가 `FRIDGE_DEMO_SEED_EXECUTED` 이벤트를 기록한다.
  - `audit_log` 엔티티·마이그레이션(V38, V39)이 존재해 관리자 작업(검사 제출/취소, 재배분, 일정 CRUD)이 JSONB detail과 함께 저장된다.
- **냉장고 포장/물품**
  - `FridgeService`가 슬롯 접근 제어, 잠금·용량 검증, 라벨 재사용, CRUD를 모두 처리하고, 관리자 재배분(`FridgeReallocationService`)은 감사 로그까지 남긴다.
  - 프런트 `FridgeContext`는 같은 정책(422/423)으로 에러 메시지와 상태 동기화를 처리한다.
- **검사/벌점/알림 파이프라인**
  - `InspectionService`가 세션 시작→조치→벌점(`PenaltyHistory`)→제출→알림까지 end-to-end 구현한다.
  - `NotificationService.sendInspectionResultNotifications`가 사용자별 dedupe 키와 메타데이터(session/action/penalty ids)를 세팅하고, `features/notifications` 훅이 그대로 소비한다.
  - `FridgeExpiryNotificationScheduler`는 임박/만료 배치 알림과 실패 로그를 운영 수준으로 관리한다.
- **일정 & 감사**
  - `InspectionScheduleService`가 층별장 권한과 칸/시간 중복을 서버에서 차단하고, 일정 생성/수정/삭제마다 `notifyResidentsOfSchedule` + `recordScheduleAudit`를 호출한다.
  - 프런트 `frontend/app/fridge/inspections/page.tsx`가 동일 API로 일정 UI와 검사 시작 플로우를 제공한다.

이 문서는 데모/운영 모두에서 최신 구현을 근거로 사용해야 하며, 새로운 기능이 추가되면 `사전 준비`, `시연 흐름`, `향후 작업` 순으로 업데이트한다.
