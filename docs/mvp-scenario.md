# DormMate 냉장고 MVP 시연 시나리오
*이번 배포/데모에서 반드시 보여 줄 사용자 흐름과 정책을 정리한 기준 문서입니다. 모든 설명은 현재 구현(2025-11)과 동기화되어 있습니다.*

## 1. 데모 목표
- 라벨 자동 발급, 검사·벌점·알림 파이프라인, 관리자 통제를 10분 이내에 연속 시연한다.
- “거주자 → 층별장 → 관리자” 순으로 단일 데이터가 흐른다는 점을 강조한다.
- 실서비스와 동일한 prod 프로파일(+실제 DB/Redis) 환경에서 데모를 진행해 신뢰를 확보한다.

## 2. 사전 준비

### 2.1 환경
- 발표용 서버에 최신 이미지를 배포하고 `./auto deploy up --build`로 전체 스택(app + frontend + PostgreSQL + Redis + proxy/nginx + certbot)을 기동한다. 문제가 생기면 `./auto deploy reset --build`로 DB 초기화→마이그레이션→재배포까지 한 번에 처리할 수 있다.
- `deploy/.env.prod`를 최신 비밀 값으로 채워 두고, `ENABLE_TLS=false`(HTTP) 혹은 도메인 준비 시 `ENABLE_TLS=true`로 설정한다. 로컬 사본은 즉시 폐기한다.
- 기동 후 `./auto deploy status`, `curl http://<서버IP>/healthz`, `curl http://<서버IP>/frontend-healthz`로 백엔드/프런트 상태를 각각 확인해 둔다.

### 2.2 계정·데이터
- **계정**: 거주자 `313-1`, 보조 거주자 `313-2`, 층별장 `floor_mgr_3f`, 관리자 `admin`.
- **칸 배정표**: 냉장 1~3번(01~08/09~16/17~24호), 냉동 1칸(전체 공용) 자료를 인쇄물/슬라이드로 준비한다.
- **데모 초기화**  
  1. 관리자 화면에서 `데모 데이터 초기화` 버튼을 눌러 `/admin/seed/fridge-demo`를 실행한다. `전시 데모:` 접두사가 붙은 포장 7건과 기본 층별장 계정이 재주입된다. (운영 DB에서는 절대 실행 금지)  
     > 수동 SQL로 데이터를 지울 경우 `inspection_action_item → inspection_action → penalty_history` 순으로 FK 참조를 먼저 삭제한 뒤 `fridge_item`/`fridge_bundle`/`bundle_label_sequence`를 정리한다. `AdminSeedIntegrationTest`도 동일 흐름을 사용하므로, 같은 순서를 따르면 데모 API 실행 전에 FK 오류를 피할 수 있다.
  2. 층별장 계정으로 샘플 검사를 한 번 실행해 **폐기 1건+경고 1건**이 포함된 검사 기록을 만든다. 이 데이터가 이후 정정·알림 재조회 시 사용된다.  
  3. 필요 시 `POST /fridge/inspections/{id}/actions`를 API 클라이언트로 호출해 폐기/벌점 데이터를 미리 채워 둘 수 있다.

### 2.3 장비·네트워크
- 노트북 1대(HDMI 출력), 브라우저 3개 창(거주자/층별장/관리자) 준비. 층별장은 시크릿 창으로 실행한다.
- 관리자 계정 로그인 → 세션 만료 안내, 다중 로그인 차단 메시지가 정상 동작하는지 사전 점검.

### 2.4 자동화 명령 요약
- `./auto db migrate` : Flyway 마이그레이션 적용 (필요 시 `--repair`)
- `./auto deploy up --build` : 최신 컨테이너 빌드·기동
- `./auto deploy reset --build` : down --volumes → db/redis → migrate → up 순으로 초기화
- `./auto deploy tls issue|renew` : HTTPS 인증서 발급/갱신 (도메인 사용 시)

## 3. 시연 흐름
* **스토리텔링 (시나리오 B)**: 'FM 층별장'과 '거주자'의 상호작용이라는 매력적인 이야기를 그대로 가져왔습니다.
* **기술적 견고함 (시나리오 A)**: API 엔드포인트, `status` 배지, `max_bundle_count`, `409/422` 방어 로직, 배치 작업(`notification_dispatch_log`), 데모 리셋 등 핵심 기술 구현 내용을 이야기 속에 모두 녹여냈습니다.

이 최종 시나리오는 청중에게 **"이 서비스가 왜 필요한지"**와 **"이 시스템이 얼마나 잘 만들어졌는지"**를 동시에 보여줄 수 있습니다.

---

### 🚀 Dormmate: 최종 시연 시나리오 (A+B)

**(시연은 3개의 브라우저 창(관리자, 층별장, 거주자)을 미리 띄워두고 시작합니다.)**

#### 1단계: 멀티 로그인 (편의성 + 보안)

* **[페르소나]** 거주자 (A), 층별장 (B)
* **(시연 멘트)**
    "두 사용자가 있습니다. B는 원칙을 중시하는 FM 층별장, A는 규칙을 잘 잊는 거주자입니다. 두 사용자 모두 PC와 모바일에서 로그인합니다."

    *(PC와 모바일(다른 브라우저)로 각각 로그인하는 모습을 보여줌)*

    "보시다시피 PC로 로그인해도 모바일 세션이 끊기지 않습니다. **멀티 로그인을 허용**해 사용자 편의성을 높였습니다. 하지만 만약 리프레시 토큰이 탈취되어 다른 기기에서 사용되면, 서버가 **`deviceId` 불일치를 감지(DEVICE_MISMATCH)**하고 즉시 세션을 폐기합니다. 이것이 저희의 '편의와 보안'을 모두 잡은 첫 번째 포인트입니다."

#### 2단계: 거주자 평소 화면 (기능 확인)

* **[페르소나]** 거주자 (A)
* **(시연 멘트)**
    "먼저 거주자 A의 화면입니다. `/fridge/slots?view=full` API를 통해 본인에게 배정된 칸을 봅니다. 지금은 **'ACTIVE' 상태**이고, '최대 5개'(`max_bundle_count`)까지 보관 가능하다고 나옵니다. 여기에 포장을 하나 등록해 보겠습니다."

    *(거주자 A, 포장 1개 등록. 'A-101' 같은 라벨이 자동 발급되는 것을 보여줌)*

    "이렇게 `bundle_label_sequence`를 통해 라벨이 자동 발급되며, 만약 이 포장을 삭제하면 이 라벨은 재사용 가능한 상태로 돌아갑니다."

#### 3단계: 검사 시작 (층별장)

* **[페르소나]** 층별장 (B)
* **(시연 멘트)**
    "이제 B 층별장이 정기 검사를 시작합니다. '검사 시작' 버튼을 누릅니다. (`POST /inspections/start`)"

    *(층별장 화면에서 '검사 시작' 클릭)*

    "이 순간, `InspectionService`가 호출되어 냉장고 칸이 30분간 **'IN_INSPECTION' 상태**로 변경됩니다. 이 세션은 등록된 '검사 일정(`InspectionSchedule`)'과 자동으로 연결되며, 만약 30분 내 검사를 못 마치면 스케줄러가 세션을 `CANCELLED` 처리하여 냉장고가 무한정 잠기는 것을 방지합니다."

#### 4단계: 시스템의 견고성 (어-어 패스 1)

* **[페르소나]** 거주자 (A)
* **(시연 멘트)**
    "검사가 시작되자마자 거주자 A의 화면을 다시 보겠습니다. 새로고침을 누르자, API가 `status` 필드를 읽어와 칸에 **'검사 중' 배지**가 표시되고 '등록' 버튼이 비활성화되었습니다."

    *(거주자 A의 화면을 보여줌. 잠긴 칸에 '등록' 버튼이 비활성화된 것을 강조)*

    "만약 거주자가 이 상태를 무시하고 API로 직접 포장을 등록하려 시도하면, `ensureCompartmentNotLocked` 로직이 **`423 Locked + COMPARTMENT_LOCKED` 오류**를 반환하며 시스템의 데이터 정합성을 견고하게 지켜줍니다."

#### 5단계: 조치 및 자동화 (층별장)

* **[페르소나]** 층별장 (B)
* **(시연 멘트)**
    "다시 층별장 화면입니다. B 층별장이 유통기한이 지난 포장을 발견하고 **'폐기(DISPOSE)'** 조치를 선택합니다. (`POST /inspections/{id}/actions`)"

    *(층별장 화면에서 '폐기' 버튼 클릭)*

    "이 클릭 한 번으로, 서버에서는 3가지 핵심 로직이 동시에 실행됩니다.
    1.  모든 조치 내역은 **`inspection_action_item` 스냅샷**으로 기록됩니다.
    2.  `maybeAttachPenalty`가 호출되어, '폐기' 조치에 대한 **벌점(`PenaltyHistory`)이 자동으로 생성**됩니다.
    3.  조치가 성공했으므로 잠금 시간이 30분 더 연장됩니다."

#### 6단계: 제출 및 알림 (거주자)

* **[페르소나]** 층별장 (B) / 거주자 (A)
* **(시연 멘트)**
    "B 층별장이 검사를 '제출'합니다. (`POST /inspections/{id}/submit`)"

    *(층별장 화면에서 '제출' 클릭, 거주자 화면으로 전환)*

    "제출 즉시, `NotificationService`가 A 거주자에게 벌점 ID와 조치 내역이 포함된 알림을 발송합니다. `dedupe` 키로 중복 알림은 모두 차단됩니다."

    *(거주자 화면의 '알림'(/notifications) 아이콘에 배지가 뜨고, 클릭 시 '검사 결과' 알림이 최상단에 보임. 알림을 읽고, 포장 목록으로 돌아가면 검사 이후 수정된 항목을 구분하기 위해 `updatedAfterInspection` 배지가 표시되는 것을 보여줌)*

#### 7단계: 관리자의 검증 (어-어 패스 2)

* **[페르소나]** 관리자 (C)
* **(시연 멘트)**
    "마지막으로 관리자입니다. 관리자는 시스템이 규정대로 작동하는지 검증해야 합니다. 예를 들어, 관리자가 실수로 `max_bundle_count`를 현재 보관된 포장 수보다 적게 설정하려 한다면 어떻게 될까요?"

    *(관리자 화면(`/admin/fridge/compartments`)에서 `max_bundle_count`를 1로 수정 시도)*

    "예상대로 **`422 Unprocessable Entity`** 오류가 발생합니다. `FridgeAdminService`가 데이터 충돌을 막아 시스템을 보호합니다."

#### 8단계: 관리자의 강력한 운영 도구

* **[페르소나]** 관리자 (C)
* **(시연 멘트)**
    "관리자는 시스템을 총괄합니다. 예를 들어, **'호실 재배분'**(`reallocations/preview`)을 실행하면, 검사 중인 칸은 '경고(warning)'로 표시하며 안전하게 배정안을 시뮬레이션할 수 있습니다."

    *(관리자 화면에서 '호실 재배분' 미리보기와 적용을 시연)*

    "또한, 어제 층별장이 실수로 부과한 벌점을 수정해야 한다면, '검사 내역'에서 **`PATCH /inspections/{id}`**를 호출하여 조치 내역을 '정정(ADJUST)'할 수도 있습니다."

#### 9단계: 배치 작업 및 최종 추적

* **[페르소나]** 관리자 (C)
* **(시연 멘트)**
    "보이지 않는 영역도 관리됩니다. 매일 아침 9시, **`FridgeExpiryNotificationScheduler`**가 실행되어 유통기한 임박 알림을 보냅니다. 관리자는 **`notification_dispatch_log`**에서 이 배치 작업이 'SUCCESS'했는지, 혹은 특정 사용자에게 'FAILED'했는지 모두 추적할 수 있습니다."

    *(관리자 화면에서 'AuditLog' 조회)*

    "그리고 오늘 시연한 모든 핵심 행위들—'층별장의 검사 제출', '자동 벌점 부과', '관리자의 재배분'—이 **'감사 로그(AuditLog)'**에 `FRIDGE_REALLOCATION_APPLY` 같은 타입과 JSON 상세 내역으로 모두 기록되었습니다. 이것이 수기 관리의 비대칭 문제를 해결하는 Dormmate의 핵심입니다."

#### 10단계: 데모 리셋 (마무리)

* **[페르소나]** 관리자 (C)
* **(시연 멘트)**
    "시연을 마치기 전, 이 모든 데이터를 초기화하고 싶다면 관리자는 `/admin/seed/fridge-demo` API를 호출합니다. 이 API는 SQL 스크립트를 실행하여 지금 보신 모든 데이터를 데모용 초기 상태로 되돌리고, 이 실행 기록 또한 감사 로그에 남깁니다. 감사합니다."