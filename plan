#!/bin/bash
set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_PATH="$PROJECT_ROOT/.codex/config.toml"
STATE_PATH="$PROJECT_ROOT/.codex/state.json"
SCRIPT_DIR="$PROJECT_ROOT/tools/codex"

# TODO: 7-스텝 게이트 루프의 현재 단계/최근 테스트 결과를
#       "$PROJECT_ROOT/.codex/state.json"에 기록해 추적하도록 확장한다.

show_menu() {
  cat <<USAGE
=== Codex 프로필 전환 ===
  흐름: 7-스텝 게이트드 루프
    0) SSOT 문서 확인 → 1) 요구 재진술 → 2) 단계/성공조건 정리
    3) 핵심 개념 설명 → 4) 주석 스켈레톤 → 5) 구현 리뷰
    6) 테스트 실행 → 7) Taskmaster·문서 업데이트
  1) 설계      (design)      - 문서/요구 재진술
  2) 스텁      (stubs)       - 주석 뼈대/파일 생성
  3) 리뷰      (review)      - 문서 대비 코드 점검/테스트 보강
  4) 아이디어  (brainstorm)  - 이름/문구 아이디어(코드 금지)
  5) 현재 상태 확인
  6) 태스크 진행 상태 기록
  q) 종료
선택: 
USAGE
}

set_profile() {
  python3 "$SCRIPT_DIR/set_profile.py" --config "$CONFIG_PATH" "$1"
  python3 "$SCRIPT_DIR/update_state.py" --state-file "$STATE_PATH" --profile "$1" >/dev/null
  show_current
}

show_state() {
  if [ ! -f "$STATE_PATH" ]; then
    echo "state 파일이 없습니다: $STATE_PATH"
    return
  fi
  python3 - "$STATE_PATH" <<'PY'
import json, sys
from pathlib import Path
path = Path(sys.argv[1])
try:
    data = json.loads(path.read_text(encoding="utf-8"))
except Exception:
    print("state 파일을 읽을 수 없습니다.")
    sys.exit(0)

profile = data.get("current_profile", "-")
task_id = data.get("current_task_id", "-")
loop_step = data.get("current_loop_step", "-")
last_tests = data.get("last_tests", "-")
notes = data.get("notes", "-")
updated_at = data.get("updated_at", "-")

print(f" 기록된 프로필: {profile}")
print(f" 현재 태스크: {task_id}")
print(f" 루프 스텝: {loop_step}")
print(f" 최근 테스트: {last_tests}")
print(f" 비고: {notes}")
print(f" 마지막 갱신: {updated_at}")
PY
}

update_progress() {
  read -r -p "현재 Task ID (예: AUTH-01, 빈칸=유지): " task_id
  read -r -p "현재 Loop Step (0-7, 빈칸=유지): " loop_step
  read -r -p "최근 실행한 테스트 명령 (콤마 구분, 빈칸=유지): " last_tests
  read -r -p "비고(선택): " notes

  args=(--state-file "$STATE_PATH")
  if [ -n "$task_id" ]; then
    args+=(--task-id "$task_id")
  fi
  if [ -n "$loop_step" ]; then
    args+=(--loop-step "$loop_step")
  fi
  if [ -n "$last_tests" ]; then
    args+=(--last-tests "$last_tests")
  fi
  if [ -n "$notes" ]; then
    args+=(--notes "$notes")
  fi

  python3 "$SCRIPT_DIR/update_state.py" "${args[@]}"
  show_current
}

show_current() {
  if [ ! -f "$CONFIG_PATH" ]; then
    echo "config 파일이 없습니다: $CONFIG_PATH" >&2
    exit 1
  fi
  current=$(grep -E '^active_profile' "$CONFIG_PATH" | sed -E 's/active_profile[[:space:]]*=[[:space:]]*"([^"]*)".*/\1/')
  case "$current" in
    design) desc="설계 단계(스텝 1~3): 요구 재진술·단계 분해·개념 설명, 코드 금지" ;;
    stubs) desc="스텁 단계(스텝 4): 합의된 파일에 주석 스켈레톤만 생성" ;;
    review) desc="리뷰 단계(스텝 5~6): 구현 점검·테스트 실행 확인" ;;
    brainstorm) desc="아이디어 단계: 이름/문구(코드 금지)" ;;
    *) desc="알 수 없는 프로필" ;;
  esac
  printf '현재 프로필: %s (%s)\n' "$current" "$desc"
  printf '체크리스트: Step 0 문서 최신 ↔ Step 7 Taskmaster/문서 갱신까지 완료 확인.\n\n'
  show_state
  printf '\n'
}

while true; do
  show_menu
  read -r choice
  case "$choice" in
    1|design|설계)
      set_profile "design"
      ;;
    2|stubs|스텁|주석)
      set_profile "stubs"
      ;;
    3|review|리뷰|검토)
      set_profile "review"
      ;;
    4|brainstorm|아이디어|브레인스토밍)
      set_profile "brainstorm"
      ;;
    5|현재|status|current)
      show_current
      ;;
    6|기록|state|update)
      update_progress
      ;;
    q|Q|quit|exit)
      echo "⏹ 종료합니다."
      break
      ;;
    *)
      echo "⚠️  지원하지 않는 선택입니다."
      ;;
  esac
done
