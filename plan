#!/bin/bash
set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_DIR="$PROJECT_ROOT/.codex"
HOME_CONFIG="$HOME/.codex/config.toml"
STATE_PATH="$CONFIG_DIR/state.json"
SCRIPT_DIR="$PROJECT_ROOT/tools/codex"

mkdir -p "$CONFIG_DIR"

ensure_config_path() {
  if [ -f "$HOME_CONFIG" ]; then
    echo "$HOME_CONFIG"
    return 0
  fi

  echo ""
  return 1
}

CONFIG_PATH="$(ensure_config_path || true)"
if [ -z "$CONFIG_PATH" ]; then
  echo "âš ï¸  config.tomlì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ~/.codex/config.tomlì„ ìƒì„±í•˜ì„¸ìš”." >&2
fi

# TODO: 7-ìŠ¤í… ê²Œì´íŠ¸ ë£¨í”„ì˜ í˜„ì¬ ë‹¨ê³„/ìµœê·¼ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼
#       "$PROJECT_ROOT/.codex/state.json"ì— ê¸°ë¡í•´ ì¶”ì í•˜ë„ë¡ í™•ì¥í•œë‹¤.

show_menu() {
  cat <<USAGE
=== Codex í”„ë¡œí•„ ì „í™˜ ===
  íë¦„: 7-ìŠ¤í… ê²Œì´íŠ¸ë“œ ë£¨í”„
    0) SSOT ë¬¸ì„œ í™•ì¸ â†’ 1) ìš”êµ¬ ì¬ì§„ìˆ  â†’ 2) ë‹¨ê³„/ì„±ê³µì¡°ê±´ ì •ë¦¬
    3) í•µì‹¬ ê°œë… ì„¤ëª… â†’ 4) ì£¼ì„ ìŠ¤ì¼ˆë ˆí†¤ â†’ 5) êµ¬í˜„ ë¦¬ë·°
    6) í…ŒìŠ¤íŠ¸ ì‹¤í–‰ â†’ 7) TaskmasterÂ·ë¬¸ì„œ ì—…ë°ì´íŠ¸
  0) Step 0 ìë™ ì ê²€ (SSOT ë¦¬í¬íŠ¸)
  1) ì„¤ê³„      (design)      - ë¬¸ì„œ/ìš”êµ¬ ì¬ì§„ìˆ 
  2) ìŠ¤í…      (stubs)       - ì£¼ì„ ë¼ˆëŒ€/íŒŒì¼ ìƒì„±
  3) ë¦¬ë·°      (review)      - ë¬¸ì„œ ëŒ€ë¹„ ì½”ë“œ ì ê²€/í…ŒìŠ¤íŠ¸ ë³´ê°•
  4) ì•„ì´ë””ì–´  (brainstorm)  - ì´ë¦„/ë¬¸êµ¬ ì•„ì´ë””ì–´(ì½”ë“œ ê¸ˆì§€)
  5) í˜„ì¬ ìƒíƒœ í™•ì¸
  6) íƒœìŠ¤í¬ ì§„í–‰ ìƒíƒœ ê¸°ë¡
  7) Step 7 ë¦¬í¬íŠ¸ (ë¬¸ì„œ/Taskmaster ê°±ì‹  ì²´í¬)
  8) Step 6 í…ŒìŠ¤íŠ¸ ì‹¤í–‰(make tests-core)
  9) Git ìƒíƒœ ìš”ì•½
10) ì§„í–‰ ë¡œê·¸ ê¸°ë¡(workflow/logs)
 11) ì„œë¹„ìŠ¤ ë¬¸ì„œ ì´ˆì•ˆ ë¹„êµ(make docs-pending)
 12) Taskmaster lint(make task-lint)
  q) ì¢…ë£Œ
ì„ íƒ: 
USAGE
}

set_profile() {
  local config_path="${CONFIG_PATH:-}"
  if [ -z "$config_path" ] || [ ! -f "$config_path" ]; then
    config_path="$(ensure_config_path || true)"
    CONFIG_PATH="$config_path"
  fi
  if [ -z "$config_path" ] || [ ! -f "$config_path" ]; then
    echo "config íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ~/.codex/config.tomlì„ ìƒì„±í•˜ì„¸ìš”." >&2
    return 1
  fi

  python3 "$SCRIPT_DIR/set_profile.py" --config "$config_path" "$1"
  python3 "$SCRIPT_DIR/update_state.py" --state-file "$STATE_PATH" --profile "$1" >/dev/null
  show_current
}

show_state() {
  if [ ! -f "$STATE_PATH" ]; then
    echo "state íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: $STATE_PATH"
    return
  fi
  python3 - "$STATE_PATH" <<'PY'
import json, sys
from pathlib import Path
path = Path(sys.argv[1])
try:
    data = json.loads(path.read_text(encoding="utf-8"))
except Exception:
    print("state íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    sys.exit(0)

profile = data.get("current_profile", "-")
task_id = data.get("current_task_id", "-")
loop_step = data.get("current_loop_step", "-")
last_tests = data.get("last_tests", "-")
notes = data.get("notes", "-")
updated_at = data.get("updated_at", "-")

print(f" ê¸°ë¡ëœ í”„ë¡œí•„: {profile}")
print(f" í˜„ì¬ íƒœìŠ¤í¬: {task_id}")
print(f" ë£¨í”„ ìŠ¤í…: {loop_step}")
print(f" ìµœê·¼ í…ŒìŠ¤íŠ¸: {last_tests}")
print(f" ë¹„ê³ : {notes}")
print(f" ë§ˆì§€ë§‰ ê°±ì‹ : {updated_at}")
PY
}

update_progress() {
  read -r -p "í˜„ì¬ Task ID (ì˜ˆ: AUTH-01, ë¹ˆì¹¸=ìœ ì§€): " task_id
  read -r -p "í˜„ì¬ Loop Step (0-7, ë¹ˆì¹¸=ìœ ì§€): " loop_step
  read -r -p "ìµœê·¼ ì‹¤í–‰í•œ í…ŒìŠ¤íŠ¸ ëª…ë ¹ (ì½¤ë§ˆ êµ¬ë¶„, ë¹ˆì¹¸=ìœ ì§€): " last_tests
  read -r -p "ë¹„ê³ (ì„ íƒ): " notes

  args=(--state-file "$STATE_PATH")
  if [ -n "$task_id" ]; then
    args+=(--task-id "$task_id")
  fi
  if [ -n "$loop_step" ]; then
    args+=(--loop-step "$loop_step")
  fi
  if [ -n "$last_tests" ]; then
    args+=(--last-tests "$last_tests")
  fi
  if [ -n "$notes" ]; then
    args+=(--notes "$notes")
  fi

  python3 "$SCRIPT_DIR/update_state.py" "${args[@]}"
  show_current
}

show_current() {
  local config_path="${CONFIG_PATH:-}"
  if [ -z "$config_path" ] || [ ! -f "$config_path" ]; then
    config_path="$(ensure_config_path || true)"
    CONFIG_PATH="$config_path"
  fi
  if [ -z "$config_path" ] || [ ! -f "$config_path" ]; then
    echo "config íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: ~/.codex/config.tomlì„ ìƒì„±í•˜ì„¸ìš”." >&2
    show_state
    printf '\n'
    return
  fi

  current=$(grep -E '^active_profile' "$config_path" | sed -E 's/active_profile[[:space:]]*=[[:space:]]*"([^"]*)".*/\1/')
  case "$current" in
    design) desc="ì„¤ê³„ ë‹¨ê³„(ìŠ¤í… 1~3): ìš”êµ¬ ì¬ì§„ìˆ Â·ë‹¨ê³„ ë¶„í•´Â·ê°œë… ì„¤ëª…, ì½”ë“œ ê¸ˆì§€" ;;
    stubs) desc="ìŠ¤í… ë‹¨ê³„(ìŠ¤í… 4): í•©ì˜ëœ íŒŒì¼ì— ì£¼ì„ ìŠ¤ì¼ˆë ˆí†¤ë§Œ ìƒì„±" ;;
    review) desc="ë¦¬ë·° ë‹¨ê³„(ìŠ¤í… 5~6): êµ¬í˜„ ì ê²€Â·í…ŒìŠ¤íŠ¸ ì‹¤í–‰ í™•ì¸" ;;
    brainstorm) desc="ì•„ì´ë””ì–´ ë‹¨ê³„: ì´ë¦„/ë¬¸êµ¬(ì½”ë“œ ê¸ˆì§€)" ;;
    *) desc="ì•Œ ìˆ˜ ì—†ëŠ” í”„ë¡œí•„" ;;
  esac
  printf 'í˜„ì¬ í”„ë¡œí•„: %s (%s)\n' "$current" "$desc"
  printf 'ì²´í¬ë¦¬ìŠ¤íŠ¸: Step 0 ë¬¸ì„œ ìµœì‹  â†” Step 7 Taskmaster/ë¬¸ì„œ ê°±ì‹ ê¹Œì§€ ì™„ë£Œ í™•ì¸.\n\n'
  show_state
  printf '\n'
}

run_step_report() {
  local step="$1"
  if ! python3 "$SCRIPT_DIR/loop_helper.py" --project-root "$PROJECT_ROOT" --step "$step"; then
    echo "âš ï¸  loop_helper ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Python í™˜ê²½ì„ í™•ì¸í•˜ì„¸ìš”."
  fi
  echo ""
}

run_tests_core() {
  echo "ğŸ” make tests-core ì‹¤í–‰ ì¤‘..."
  if ! (cd "$PROJECT_ROOT" && make tests-core); then
    echo "âš ï¸  tests-core ì‹¤í–‰ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
    return
  fi
  python3 "$SCRIPT_DIR/update_state.py" --state-file "$STATE_PATH" --last-tests "make tests-core"
  echo "âœ… tests-core ì‹¤í–‰ ê²°ê³¼ê°€ state.jsonì— ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."
}

show_git_status() {
  echo "=== Git ìƒíƒœ ìš”ì•½ ==="
  if ! git -C "$PROJECT_ROOT" status --short --branch; then
    echo "âš ï¸  git statusë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
  fi
  echo ""
}

log_progress() {
  local log_dir="$PROJECT_ROOT/workflow/logs"
  mkdir -p "$log_dir"
  local timestamp branch
  timestamp="$(date '+%Y-%m-%d %H:%M:%S')"
  branch="$(git -C "$PROJECT_ROOT" rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'unknown')"
  local state_block
  state_block="$(python3 - "$STATE_PATH" <<'PY'
import json, sys
from pathlib import Path
path = Path(sys.argv[1])
if not path.exists():
    print("- state íŒŒì¼ ì—†ìŒ")
    sys.exit(0)
try:
    data = json.loads(path.read_text(encoding="utf-8"))
except Exception:
    print("- state íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨")
    sys.exit(0)
profile = data.get("current_profile", "-")
task_id = data.get("current_task_id", "-")
loop_step = data.get("current_loop_step", "-")
last_tests = data.get("last_tests", "-")
notes = data.get("notes", "-")
print(f"- profile      : {profile}")
print(f"- current_task : {task_id}")
print(f"- loop_step    : {loop_step}")
print(f"- last_tests   : {last_tests}")
print(f"- notes        : {notes}")
PY
)"
  local log_file="$log_dir/$(date '+%Y-%m-%d').md"
  {
    echo "## ${timestamp} (branch: ${branch})"
    echo "$state_block"
    echo ""
  } >> "$log_file"
  echo "ğŸ“ ë¡œê·¸ê°€ ${log_file}ì— ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."
}

while true; do
  show_menu
  read -r choice
  case "$choice" in
    0|step0|ssot)
      run_step_report "0"
      ;;
    1|design|ì„¤ê³„)
      set_profile "design"
      ;;
    2|stubs|ìŠ¤í…|ì£¼ì„)
      set_profile "stubs"
      ;;
    3|review|ë¦¬ë·°|ê²€í† )
      set_profile "review"
      ;;
    4|brainstorm|ì•„ì´ë””ì–´|ë¸Œë ˆì¸ìŠ¤í† ë°)
      set_profile "brainstorm"
      ;;
    5|í˜„ì¬|status|current)
      show_current
      ;;
    6|ê¸°ë¡|state|update)
      update_progress
      ;;
    7|step7|ì™„ë£Œ|report)
      run_step_report "7"
      ;;
    8|tests|test|step6)
      run_tests_core
      ;;
    9|git|status)
      show_git_status
      ;;
    10|log|record)
      log_progress
      ;;
    11|drafts|docs)
      (cd "$PROJECT_ROOT" && make docs-pending)
      ;;
    12|task|lint)
      (cd "$PROJECT_ROOT" && make task-lint)
      ;;
    q|Q|quit|exit)
      echo "â¹ ì¢…ë£Œí•©ë‹ˆë‹¤."
      break
      ;;
    *)
      echo "âš ï¸  ì§€ì›í•˜ì§€ ì•ŠëŠ” ì„ íƒì…ë‹ˆë‹¤."
      ;;
  esac
done
