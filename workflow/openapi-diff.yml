name: OpenAPI 차이점 검증
on: [push, pull_request]     # 이유: 모든 변경에서 계약이 깨지지 않는지 즉시 검증

jobs:
  openapi-diff:
    name: OpenAPI 차이점 체크
    runs-on: ubuntu-latest
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4   # PR의 코드/Seed 동시 체크아웃
      
      - name: Java 환경 설정
        uses: actions/setup-java@v4 # springdoc가 서버에서 문서를 뽑으므로 자바 필요
        with: { distribution: temurin, java-version: '21' }
      
      - name: Node.js 환경 설정
        uses: actions/setup-node@v4 # npm openapi-diff 실행용
        with: { node-version: '20' }
      
      - name: 서버 JAR 빌드
        run: ./gradlew bootJar      # 서버 JAR 빌드(최소 구동)
      
      - name: 서버 임시 실행
        run: java -jar build/libs/*.jar & sleep 6  # 임시 부팅 후 엔드포인트 노출 대기
      
      - name: Runtime 명세 덤프
        run: bash scripts/export-openapi.sh        # Runtime 명세 덤프
      
      - name: Seed와 비교
        run: bash scripts/diff-openapi.sh          # Seed와 비교 → 다르면 실패