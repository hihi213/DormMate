#!/usr/bin/env bash
# #!/usr/bin/env bash: 이 스크립트를 bash 셸로 실행하라고 지정하는 'shebang'입니다.
# '/bin/bash'보다 '/usr/bin/env bash'를 사용하면, 사용자 환경(env)에 설정된 bash를 찾아 실행하므로 이식성이 더 높습니다.

# 목적: 서버가 생성한 OpenAPI(JSON)를 파일로 떨궈서 Seed와 비교한다.
#       실행 중인 애플리케이션이 실시간으로 생성해주는 OpenAPI 명세(현재 코드의 상태)를 가져오는 역할을 합니다.
# 이유: 문서-코드 드리프트를 자동으로 감지해 "설계 먼저" 문화를 강제.
#       우리가 먼저 YAML로 정의한 설계 원본(Seed)과, 실제 코드가 생성한 명세가 달라지는 '드리프트' 현상을 막기 위함입니다.

# set -euo pipefail: 어떤 스크립트든 시작 부분에 추가해야 할 매우 중요한 설정입니다. "방어적 프로그래밍"의 핵심이죠.
set -euo pipefail
# -e: 스크립트 내의 어떤 명령이라도 실패(종료 코드 0이 아님)하면 즉시 스크립트 전체를 중단시킵니다. 에러를 무시하고 진행하는 것을 막습니다.
# -u: 정의되지 않은 변수를 사용하려고 하면 에러로 간주하고 스크립트를 중단시킵니다. 오타로 인한 버그를 방지합니다.
# -o pipefail: 파이프라인(|)으로 연결된 여러 명령어 중 하나라도 실패하면, 전체 파이프라인을 실패로 처리합니다. (예: `명령1 | 명령2` 에서 명령1이 실패해도 스크립트가 중단됨)

# URL 변수를 설정합니다. 스크립트 실행 시 첫 번째 인자($1)가 있으면 그 값을 사용하고, 없으면 ':-' 뒤의 기본값을 사용합니다.
# 이를 통해 다른 환경(스테이징, 운영)의 URL을 인자로 넘겨 재사용할 수 있습니다.
URL=${1:-http://localhost:8080/v3/api-docs}    # springdoc의 표준 엔드포인트. Spring Boot와 springdoc-openapi 라이브러리를 사용하면 이 경로에서 현재 API 명세를 JSON 형식으로 제공합니다.

# CI 환경이나 로컬에서 스크립트를 실행할 때 'build' 디렉토리가 없을 수도 있으므로 생성합니다.
mkdir -p build                                 # CI/로컬 공통 산출물 디렉토리
# -p 옵션은 상위 디렉토리가 없으면 함께 생성해주고, 디렉토리가 이미 존재하더라도 에러를 발생시키지 않아 스크립트를 여러 번 실행해도 안전합니다.

# curl 명령어로 지정된 URL의 내용을 가져와 파일로 저장합니다.
curl -fsSL "$URL" > build/openapi.generated.json
# -f: HTTP 서버 에러(4xx, 5xx) 발생 시, HTML 에러 페이지를 출력하는 대신 조용히 실패하고 non-zero 종료 코드를 반환합니다. 위에서 설정한 'set -e'가 이 실패를 감지하여 스크립트를 중단시킵니다.
# -s: 진행 상황(progress bar)을 표시하지 않는 'silent' 모드입니다.
# -S: -s와 함께 사용하며, 에러가 발생했을 경우에는 에러 메시지를 출력해줍니다. (-s의 침묵을 깨는 옵션)
# -L: 서버가 리다이렉션(3xx) 응답을 보낼 경우, 해당 위치를 따라갑니다.
# > build/openapi.generated.json: curl이 가져온 결과(stdout)를 'build/openapi.generated.json' 파일에 덮어쓰기(redirect)합니다.

# 스크립트가 성공적으로 완료되었음을 사용자에게 알려주는 확인 메시지입니다.
echo "✅ Runtime OpenAPI 명세가 build/openapi.generated.json에 저장되었습니다"
# 이 스크립트의 다음 단계는 보통 openapi-diff 같은 도구를 사용하여 Seed 파일과 방금 생성된 이 파일을 비교하는 것입니다.