#!/bin/bash
set -euo pipefail

usage() {
  cat <<USAGE
사용법: plan-develop | plan-wrap | plan-brainstorm
현재 프로필 확인: plan-current
USAGE
}

COMMAND=${1:-}
if [ -z "$COMMAND" ]; then
  usage
  exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
CONFIG_PATH="$PROJECT_ROOT/.codex/config.toml"

set_profile() {
  python3 "$SCRIPT_DIR/set_profile.py" --config "$CONFIG_PATH" "$1"
  plan-current
}

case "$COMMAND" in
  plan-develop)
    set_profile "develop"
    ;;
  plan-wrap)
    set_profile "wrap-up"
    ;;
  plan-brainstorm)
    set_profile "brainstorm"
    ;;
  plan-current)
    current=$(grep -E '^active_profile' "$CONFIG_PATH" | sed -E 's/active_profile[[:space:]]*=[[:space:]]*"([^"]*)".*/\1/')
    case "$current" in
      develop)
        desc="develop 단계: Step 0~6 설계→구현→테스트"
        ;;
      brainstorm)
        desc="브레인스토밍: 이름/문구 아이디어 탐색 (코드 금지)"
        ;;
      wrap-up)
        desc="wrap-up 단계: Step 7 Taskmaster/문서/배포 정리"
        ;;
      *)
        desc="알 수 없는 프로필"
        ;;
    esac
    echo "현재 프로필: $current ($desc)"
    ;;
  *)
    usage
    exit 1
    ;;
}
